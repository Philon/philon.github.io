<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo48x48.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo48x48.png">
  <link rel="mask-icon" href="/images/logo.png" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ixx.life","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="æœ¬æ–‡æºç ï¼šhttps:&#x2F;&#x2F;github.com&#x2F;Philon&#x2F;rpi-drivers&#x2F;tree&#x2F;master&#x2F;07-pdd ä»ã€Šæ ‘è“æ´¾é©±åŠ¨å¼€å‘å®æˆ˜ã€‹çš„ç¬¬ä¸€ç¯‡è‡³ä»Šï¼Œéƒ½æ˜¯åœ¨å†™å•ä¸ªå­—ç¬¦è®¾å¤‡ï¼Œè¿™å…¶ä¸­ä¸éš¾å‘ç°ä¸ªé—®é¢˜â€”â€”å¦‚æœæˆ‘æœ‰10ä¸ªLEDç¯å°±æ„å‘³ç€æˆ‘è¦å†™10ä¸ªledå­—ç¬¦è®¾å¤‡é©±åŠ¨ï¼Œè€Œå…¶ä¸­çš„å¤§éƒ¨åˆ†ä»£ç éƒ½æ˜¯é‡å¤çš„ï¼Œå®ƒä»¬ä¹‹é—´å¯èƒ½ä»…ä»…æ˜¯æ§åˆ¶å¼•è„šä¸åŒã€‚ ä¸€æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒäºŒæ˜¯ä¹‹åçš„é©±åŠ¨å¼€å‘æ›´å¤šä¼šæ¶‰åŠUSBã€IÂ²Cã€">
<meta property="og:type" content="article">
<meta property="og:title" content="07ï¼šPDDä¸è®¾å¤‡æ ‘">
<meta property="og:url" content="https://ixx.life/RPiDriverInAction/07/index.html">
<meta property="og:site_name" content="è‡ªå¢äººç”Ÿ">
<meta property="og:description" content="æœ¬æ–‡æºç ï¼šhttps:&#x2F;&#x2F;github.com&#x2F;Philon&#x2F;rpi-drivers&#x2F;tree&#x2F;master&#x2F;07-pdd ä»ã€Šæ ‘è“æ´¾é©±åŠ¨å¼€å‘å®æˆ˜ã€‹çš„ç¬¬ä¸€ç¯‡è‡³ä»Šï¼Œéƒ½æ˜¯åœ¨å†™å•ä¸ªå­—ç¬¦è®¾å¤‡ï¼Œè¿™å…¶ä¸­ä¸éš¾å‘ç°ä¸ªé—®é¢˜â€”â€”å¦‚æœæˆ‘æœ‰10ä¸ªLEDç¯å°±æ„å‘³ç€æˆ‘è¦å†™10ä¸ªledå­—ç¬¦è®¾å¤‡é©±åŠ¨ï¼Œè€Œå…¶ä¸­çš„å¤§éƒ¨åˆ†ä»£ç éƒ½æ˜¯é‡å¤çš„ï¼Œå®ƒä»¬ä¹‹é—´å¯èƒ½ä»…ä»…æ˜¯æ§åˆ¶å¼•è„šä¸åŒã€‚ ä¸€æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒäºŒæ˜¯ä¹‹åçš„é©±åŠ¨å¼€å‘æ›´å¤šä¼šæ¶‰åŠUSBã€IÂ²Cã€">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-11-16T07:27:01.000Z">
<meta property="article:modified_time" content="2021-07-21T22:56:15.021Z">
<meta property="article:author" content="Philon">
<meta property="article:tag" content="ARM">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="é©±åŠ¨å¼€å‘">
<meta property="article:tag" content="åµŒå…¥å¼">
<meta property="article:tag" content="æ ‘è“æ´¾">
<meta property="article:tag" content="è®¾å¤‡æ ‘">
<meta property="article:tag" content="æ€»çº¿">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://ixx.life/RPiDriverInAction/07/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>07ï¼šPDDä¸è®¾å¤‡æ ‘ | è‡ªå¢äººç”Ÿ</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">è‡ªå¢äººç”Ÿ</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">ä½•ä»¥è§£å¿§ï¼Œå”¯æœ‰ i++</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-books">

    <a href="/books/" rel="section"><i class="fa  fa-book fa-fw"></i>è¯»ä¹¦å†™ä½œ</a>

  </li>
        <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-pen fa-fw"></i>å­¦ä¹ ç¬”è®°</a>

  </li>
        <li class="menu-item menu-item-leetcode">

    <a href="/leetcode/" rel="section"><i class="fa fa-fire fa-fw"></i>LeetCode</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ixx.life/RPiDriverInAction/07/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Philon">
      <meta itemprop="description" content="ä¸€ä¸ªç¨‹åºå‘˜çš„æˆé•¿è¶³è¿¹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è‡ªå¢äººç”Ÿ">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          07ï¼šPDDä¸è®¾å¤‡æ ‘
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-11-16 15:27:01" itemprop="dateCreated datePublished" datetime="2019-11-16T15:27:01+08:00">2019-11-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%A0%91%E8%8E%93%E6%B4%BE%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/" itemprop="url" rel="index"><span itemprop="name">æ ‘è“æ´¾é©±åŠ¨å¼€å‘å®æˆ˜</span></a>
                </span>
            </span>

          
            <span id="/RPiDriverInAction/07/" class="post-meta-item leancloud_visitors" data-flag-title="07ï¼šPDDä¸è®¾å¤‡æ ‘" title="é˜…è¯»æ¬¡æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/RPiDriverInAction/07/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/RPiDriverInAction/07/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>æœ¬æ–‡æºç ï¼š<a target="_blank" rel="noopener" href="https://github.com/Philon/rpi-drivers/tree/master/07-pdd">https://github.com/Philon/rpi-drivers/tree/master/07-pdd</a></p>
<p>ä»ã€Šæ ‘è“æ´¾é©±åŠ¨å¼€å‘å®æˆ˜ã€‹çš„ç¬¬ä¸€ç¯‡è‡³ä»Šï¼Œéƒ½æ˜¯åœ¨å†™å•ä¸ªå­—ç¬¦è®¾å¤‡ï¼Œè¿™å…¶ä¸­ä¸éš¾å‘ç°ä¸ªé—®é¢˜â€”â€”å¦‚æœæˆ‘æœ‰10ä¸ªLEDç¯å°±æ„å‘³ç€æˆ‘è¦å†™10ä¸ªledå­—ç¬¦è®¾å¤‡é©±åŠ¨ï¼Œè€Œå…¶ä¸­çš„å¤§éƒ¨åˆ†ä»£ç éƒ½æ˜¯é‡å¤çš„ï¼Œå®ƒä»¬ä¹‹é—´å¯èƒ½ä»…ä»…æ˜¯æ§åˆ¶å¼•è„šä¸åŒã€‚</p>
<p>ä¸€æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒäºŒæ˜¯ä¹‹åçš„é©±åŠ¨å¼€å‘æ›´å¤šä¼šæ¶‰åŠUSBã€IÂ²Cã€UARTä¹‹ç±»çš„æ€»çº¿è®¾å¤‡ï¼Œä¸‰æ˜¯ä¸ºäº†æ›´å¥½åœ°ç†è§£Linuxé©±åŠ¨æ¶æ„ã€‚ä»æœ¬ç¯‡æ–‡ç« å¼€å§‹æ­£å¼ä»¥<code>é©±åŠ¨-æ€»çº¿-è®¾å¤‡</code>æ¨¡å‹å’Œ<code>è®¾å¤‡æ ‘</code>æœºåˆ¶æ¥ç¼–å†™è®¾å¤‡é©±åŠ¨ã€‚æˆ‘è§‰å¾—ä»¥<strong>å¹³å°é©±åŠ¨è®¾å¤‡</strong>æ¨¡å‹ä½œä¸ºåˆ‡å…¥ç‚¹è¾ƒå¥½â€”â€”å¯ä»¥ä¸æ¶‰åŠçœŸå®çš„ç¡¬ä»¶ã€‚</p>
<h2 id="é©±åŠ¨-æ€»çº¿-è®¾å¤‡æ¨¡å‹"><a href="#é©±åŠ¨-æ€»çº¿-è®¾å¤‡æ¨¡å‹" class="headerlink" title="é©±åŠ¨-æ€»çº¿-è®¾å¤‡æ¨¡å‹"></a>é©±åŠ¨-æ€»çº¿-è®¾å¤‡æ¨¡å‹</h2><p>Linux2.6ä¹‹åå¼•å…¥äº†å…¨æ–°é©±åŠ¨æ³¨å†Œç®¡ç†æœºåˆ¶ï¼š<strong>é©±åŠ¨ã€æ€»çº¿ã€è®¾å¤‡</strong>ã€‚ä¸€å¥è¯ï¼Œä¸ºäº†é«˜å†…èšä½è€¦åˆï¼</p>
<ul>
<li>é©±åŠ¨éƒ¨åˆ†ï¼šè´Ÿè´£å®ç°è®¾å¤‡çš„æ§åˆ¶é€»è¾‘åŠç”¨æˆ·æ¥å£ï¼Œå¹¶æ³¨å†Œåˆ°å†…æ ¸</li>
<li>è®¾å¤‡éƒ¨åˆ†ï¼šè´Ÿè´£æè¿°è®¾å¤‡çš„ç¡¬ä»¶èµ„æºï¼Œå¹¶å‘ŠçŸ¥å†…æ ¸</li>
<li>æ€»çº¿éƒ¨åˆ†ï¼šè´Ÿè´£å®ç°è®¾å¤‡ä¸é©±åŠ¨ä¹‹é—´çš„æ„ŸçŸ¥ã€è¯†åˆ«ã€åŒ¹é…è§„åˆ™</li>
</ul>
<p>ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœæœ‰100ä¸ªæŒ‰é”®(æ¯”å¦‚é”®ç›˜)ï¼Œæˆ‘åªéœ€è¦å®ç°<code>1ä¸ªæŒ‰é”®é©±åŠ¨</code>+<code>100ä¸ªæŒ‰é”®è®¾å¤‡æè¿°</code>ï¼Œå¹¶æŠŠå®ƒä»¬æŒ‚åˆ°<code>æŒ‰é”®æ€»çº¿</code>ä¸Šï¼Œæ€»çº¿ä¼šè´Ÿè´£æŠŠäºŒè€…åŒ¹é…èµ·æ¥ï¼Œæ‰€æœ‰çš„æŒ‰é”®å°±éƒ½å¯ä»¥ç”¨äº†ã€‚</p>
<p>å†…æ ¸æä¾›äº†ç›¸åº”çš„<code>busã€deviceã€driverã€class</code>ç­‰æœ€ä¸ºåº•å±‚çš„APIå’Œæ•°æ®ç»“æ„ï¼Œå³<code>é©±åŠ¨ã€æ€»çº¿ã€è®¾å¤‡</code>æ¨¡å‹æ¥ç®¡ç†ç³»ç»Ÿè®¾å¤‡ã€‚ä½†åœ¨æ—¥å¸¸é©±åŠ¨å¼€å‘ä¸­ï¼Œä¸€èˆ¬æ˜¯ç”¨ä¸åˆ°çš„ã€‚å› ä¸ºå¸¸è§ç‰©ç†æ€»çº¿éƒ½åŸºäºè¿™äº›APIå°è£…äº†å¯¹åº”çš„å¦‚<code>usb_busã€usb_deviceã€usb_driverã€tty_deviceã€tty_driver</code>ç­‰æ¥å£ï¼Œæ—¥å¸¸çš„è®¾å¤‡é©±åŠ¨å¼€å‘æ›´å¤šä»¥è¿™ä¸€å±‚æ‰“äº¤é“ã€‚</p>
<p>ç”¨é¢å‘å¯¹è±¡çš„æ€æƒ³æ¥è¯´ï¼Œé©±åŠ¨æ€»çº¿è®¾å¤‡æ¨¡å‹å°±æ˜¯DeviceManageåŸºç±»ï¼Œç”±æ­¤æ´¾ç”Ÿå‡ºäº†USBã€TTYã€IÂ²Cã€SPIã€PCIeã€GPIOç­‰è®¾å¤‡ç®¡ç†æœºåˆ¶ã€‚å½“ç„¶ï¼Œè¿™å…¶ä¸­ä¹ŸåŒ…æ‹¬<code>platform</code>å¹³å°è®¾å¤‡ç®¡ç†ã€‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">philon@rpi:~ $ ls /sys/bus/</span><br><span class="line">amba         container     genpd  i2c              media     mmc_rpmb  scsi  usb</span><br><span class="line">clockevents  cpu           gpio   iscsi_flashnode  mipi-dsi  nvmem     sdio  workqueue</span><br><span class="line">clocksource  event_source  hid    mdio_bus         mmc       platform  spi</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡<code>/sys/bus</code>ç›®å½•å¯ä»¥çœ‹åˆ°ç³»ç»Ÿå½“å‰å­˜åœ¨çš„æ€»çº¿ã€‚ğŸ‘†æ³¨æ„çœ‹å€’æ•°ç¬¬äºŒä¸ªï¼Œ<code>platform</code>å¹³å°æ€»çº¿å‡ºç°äº†ï¼ï¼</p>
<h2 id="å¹³å°æ€»çº¿ã€å¹³å°é©±åŠ¨ã€å¹³å°è®¾å¤‡"><a href="#å¹³å°æ€»çº¿ã€å¹³å°é©±åŠ¨ã€å¹³å°è®¾å¤‡" class="headerlink" title="å¹³å°æ€»çº¿ã€å¹³å°é©±åŠ¨ã€å¹³å°è®¾å¤‡"></a>å¹³å°æ€»çº¿ã€å¹³å°é©±åŠ¨ã€å¹³å°è®¾å¤‡</h2><p><strong>platformæ˜¯ä¸€ç§è™šæ‹Ÿæ€»çº¿</strong>ã€‚å®ƒæ˜¯â€œé©±åŠ¨-æ€»çº¿-è®¾å¤‡â€æ¨¡å‹çš„ä¸€ç§å®ç°ï¼Œä¸<code>usb_bus tty_bus spi_bus</code>ç­‰ç‰©ç†æ€»çº¿å¹³çº§ã€‚ä¸ºäº†æŠŠé‚£äº›ä¸èµ°æ€»çº¿æ¶æ„çš„è®¾å¤‡å›Šæ‹¬è¿›æ¥ã€‚</p>
<p>å›é¡¾å†å²ï¼š</p>
<ol>
<li>ç¼–å†™å­—ç¬¦è®¾å¤‡<code>cdev</code>æ—¶éœ€è¦å…³å¿ƒä¸»ã€æ¬¡è®¾å¤‡å·ï¼Œè¿˜è¦ç”¨mknodå‘½ä»¤åˆ›å»ºå¯¹åº”çš„è®¾å¤‡èŠ‚ç‚¹ã€‚</li>
<li>äºæ˜¯å†…æ ¸æä¾›<code>misc</code>æ··æ‚è®¾å¤‡ï¼Œå°†æ‰€æœ‰ä¸å¥½ç®¡ç†çš„å­—ç¬¦è®¾å¤‡ç»Ÿä¸€ä¸»è®¾å¤‡å·ä¸º10ï¼Œè‡ªåŠ¨åˆ†é…å’Œåˆ›å»ºèŠ‚ç‚¹ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯åŸºäºcdevå†å°è£…äº†ä¸€å±‚ã€‚</li>
<li>ä¸ºäº†ç®¡ç†æ€»çº¿è®¾å¤‡ï¼Œå†…æ ¸åˆæå‡ºäº†<code>é©±åŠ¨æ€»çº¿è®¾å¤‡</code>æ¨¡å‹ï¼Œå¹¶å°è£…äº†å„ç§USBã€IÂ²Cã€TTYç­‰è½¯ä»¶å±‚ã€‚</li>
<li>ä¸ºäº†æŠŠéæ€»çº¿æ¶æ„çš„è®¾å¤‡ä¹Ÿç”¨æ€»çº¿æ€æƒ³æ¥ç®¡ç†ï¼Œå†…æ ¸æå‡ºäº†<code>å¹³å°é©±åŠ¨è®¾å¤‡</code>å±‚</li>
</ol>
<p>æ‰€ä»¥ï¼Œ<code>platform</code>å’Œ<code>misc</code>ä¸€æ ·ï¼Œéƒ½æ˜¯ä¸ºäº†ç»™<code>â€œå…¶ä»–â€</code>è®¾å¤‡æ‰¾ä¸€ä¸ªçˆ¸çˆ¸ã€‚</p>
<h2 id="æœ€ç®€å•çš„PDDå®ä¾‹"><a href="#æœ€ç®€å•çš„PDDå®ä¾‹" class="headerlink" title="æœ€ç®€å•çš„PDDå®ä¾‹"></a>æœ€ç®€å•çš„PDDå®ä¾‹</h2><p>æ ¹æ®ä¸Šè¿°å¯æ¨æ–­ï¼Œ<code>platform_bus</code>(å³æ€»çº¿éƒ¨åˆ†)å†…æ ¸å·²ç»å®ç°äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å®ç°ä¸¤è¾¹çš„<code>platform_xxx_driver</code>å’Œ<code>platform_xxx_device</code>å³å¯ï¼Œç„¶åæŠŠå®ƒä»¬æŒ‚åˆ°å¹³å°æ€»çº¿ä¸Šå»ï¼Œæ€»çº¿ä¼šè‡ªåŠ¨è¿›è¡ŒåŒ¹é…çš„ã€‚ä»¥ä¸‹åªæ˜¯ä»¥ledä¸ºä¾‹è¯´æ˜platformç›¸å…³æ¥å£ç”¨æ³•ï¼Œå¹¶æœªçœŸæ­£å®ç°ledé©±åŠ¨ã€‚</p>
<p>led_driver.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;Dual BSD/GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Philon | https://ixx.life&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“æ€»çº¿åŒ¹é…åˆ°è®¾å¤‡æ—¶è°ƒç”¨è¯¥å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">led_probe</span><span class="params">(struct platform_device* dev)</span> </span>&#123;</span><br><span class="line">  printk(<span class="string">&quot;led %s probe\n&quot;</span>, dev-&gt;name);</span><br><span class="line">  <span class="comment">// todo: å­—ç¬¦è®¾å¤‡æ³¨å†Œã€gpioç”³è¯·ä¹‹ç±»çš„</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“æ€»çº¿åŒ¹é…åˆ°è®¾å¤‡å¸è½½æ—¶è°ƒç”¨è¯¥å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">led_remove</span><span class="params">(struct platform_device* dev)</span> </span>&#123;</span><br><span class="line">  printk(<span class="string">&quot;led %s removed\n&quot;</span>, dev-&gt;name);</span><br><span class="line">  <span class="comment">// todo: å…¶ä»–èµ„æºé‡Šæ”¾</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¹³å°é©±åŠ¨æè¿°</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">led_driver</span> =</span> &#123;</span><br><span class="line">  .probe = led_probe,</span><br><span class="line">  .remove = led_remove,</span><br><span class="line">  .driver = &#123;</span><br><span class="line">    .name = <span class="string">&quot;my_led&quot;</span>, <span class="comment">// ğŸ‘ˆåŠ¡å¿…æ³¨æ„ï¼Œplatformæ˜¯ä»¥nameæ¯”å¯¹æ¥åŒ¹é…çš„</span></span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ã€å®ã€‘å°†ledé©±åŠ¨æŒ‚åˆ°å¹³å°æ€»çº¿ä¸Š</span></span><br><span class="line"><span class="comment">// ç›¸å½“äºåŒæ—¶å®šä¹‰äº†æ¨¡å—çš„å…¥å£å’Œå‡ºå£å‡½æ•°</span></span><br><span class="line"><span class="comment">// module_init(platform_driver_register)</span></span><br><span class="line"><span class="comment">// module_exit(platform_driver_unregister)</span></span><br><span class="line">module_platform_driver(led_driver);</span><br></pre></td></tr></table></figure>

<p>led_device.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;Dual BSD/GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Philon | https://ixx.life&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// âš ï¸æœ€å¥½å®ç°è¯¥æ¥å£ï¼Œå¦åˆ™åœ¨è®¾å¤‡é‡Šæ”¾çš„æ—¶å€™å†…æ ¸ä¼šæŠ¥é”™</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">led_release</span><span class="params">(struct device* pdev)</span> </span>&#123;</span><br><span class="line">  printk(<span class="string">&quot;led release!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¹³å°è®¾å¤‡æè¿°</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> <span class="title">led_device</span> =</span> &#123;</span><br><span class="line">  .name = <span class="string">&quot;my_led&quot;</span>, <span class="comment">// ğŸ‘ˆè¦ç¡®ä¿ä¸led_driverçš„å®šä¹‰ä¸€è‡´ï¼Œå¦åˆ™åŒ¹é…ä¸ä¸Š</span></span><br><span class="line">  .dev = &#123;</span><br><span class="line">    .release = led_release,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†è®¾å¤‡æ³¨å†Œåˆ°å¹³å°æ€»çº¿</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">leddev_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  platform_device_register(&amp;led_device);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">module_init(leddev_init);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">leddev_exit</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  platform_device_unregister(&amp;led_device);</span><br><span class="line">&#125;</span><br><span class="line">module_exit(leddev_exit);</span><br></pre></td></tr></table></figure>

<p>ç®€è¿°ä¸€ä¸‹ä»£ç çš„é€»è¾‘ï¼š</p>
<ol>
<li>platform_busç›‘å¬åˆ°æœ‰deviceæ³¨å†Œæ—¶ï¼Œä¼šæŸ¥çœ‹å®ƒçš„<code>device.name</code></li>
<li>platform_busä¼šæŸ¥æ‰¾æ‰€æœ‰çš„<code>driver.name</code>ï¼Œæ‰¾åˆ°ä¹‹åå°†è®¾å¤‡å’Œé©±åŠ¨è¿›è¡Œç»‘å®š</li>
<li>ç»‘å®šæˆåŠŸåï¼Œ<code>platform_driver.probe()</code>å°†è§¦å‘ï¼Œåˆšæ‰çš„è®¾å¤‡ä½œä¸ºå‚æ•°ä¼ é€’è¿›å»</li>
<li>å‰©ä¸‹çš„äº‹æƒ…ï¼Œå°±çœ‹ä½ å¦‚ä½•å®ç°platform_driveräº†â€¦</li>
</ol>
<p>å®é™…æ“ä½œä¸‹ï¼ŒåŠ è½½led_driver.koæ¨¡å—åï¼Œå¯ä»¥åœ¨å¹³å°æ€»çº¿ç›®å½•ä¸‹çœ‹åˆ°<code>my_led</code>é©±åŠ¨äº†ã€‚ç„¶åï¼ŒåŠ è½½led_device.koæ¨¡å—åï¼ŒåŒæ ·å¯ä»¥åœ¨å¹³å°æ€»çº¿è®¾å¤‡é‡ŒæŸ¥çœ‹åˆ°<code>my_led.0</code>çš„è®¾å¤‡ã€‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¹³å°æ€»çº¿é‡ŒæŸ¥çœ‹my_ledé©±åŠ¨</span></span><br><span class="line">philon@rpi:~/modules $ sudo insmod led_driver.ko </span><br><span class="line">philon@rpi:~/modules $ ls /sys/bus/platform/drivers/my_led/</span><br><span class="line"><span class="built_in">bind</span>  module  uevent  unbind</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¹³å°æ€»çº¿é‡ŒæŸ¥çœ‹my_ledè®¾å¤‡</span></span><br><span class="line">philon@rpi:~/modules $ sudo insmod led_device.ko      </span><br><span class="line">philon@rpi:~/modules $ ls /sys/bus/platform/devices/my_led.0/</span><br><span class="line">driver  driver_override  modalias  power  subsystem  uevent</span><br><span class="line"></span><br><span class="line"><span class="comment"># çœ‹ä¸€ä¸‹å†…æ ¸æ‰“å°ä¿¡æ¯</span></span><br><span class="line">philon@rpi:~/modules $ dmesg</span><br><span class="line">[225668.547712] led my_led probe</span><br><span class="line">[225687.213336] led my_led removed</span><br><span class="line">[225687.213448] led release!</span><br></pre></td></tr></table></figure>

<p>âš ï¸æ¸©é¦¨æç¤ºï¼šä¸å¿…æ“å¿ƒdriver/deviceæ¨¡å—çš„åŠ è½½é¡ºåºï¼Œè°å…ˆè°åéƒ½ä¸€æ ·ï¼Œplatform_busä¼šæ–™ç†å¥½ä¸€åˆ‡ã€‚</p>
<p>ä»¥ä¸Šï¼Œä¾¿æ˜¯PDDæ¨¡å‹çš„ä¸€ä¸ªåŸºæœ¬å±•ç¤ºï¼Œå¦‚æœä½ æ„¿æ„ï¼Œå¯ä»¥åœ¨led_device.cæ–‡ä»¶é‡Œå¤šæ³¨å†Œå‡ ä¸ªè®¾å¤‡ã€‚ä¸è¿‡åœ¨æ­¤ä¹‹å‰â€”â€”ä½ å†…å¿ƒéš¾é“ä¸ä¼šå……æ»¡ç–‘æƒ‘å—ï¼šè¿™tmæ€ä¹ˆåŒ¹é…ä¸Šçš„å‘€ï¼ŸğŸ¤”ï¸</p>
<h2 id="å¹³å°é©±åŠ¨å’Œè®¾å¤‡çš„åŒ¹é…"><a href="#å¹³å°é©±åŠ¨å’Œè®¾å¤‡çš„åŒ¹é…" class="headerlink" title="å¹³å°é©±åŠ¨å’Œè®¾å¤‡çš„åŒ¹é…"></a>å¹³å°é©±åŠ¨å’Œè®¾å¤‡çš„åŒ¹é…</h2><p>çœ‹ä¸€ä¸‹å†…æ ¸æ˜¯å¦‚ä½•å®ç°å¹³å°åŒ¹é…çš„ï¼Œéå¸¸å®¹æ˜“ç†è§£ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// linux-rpi-4.19.y/drivers/base/platform.c line:963</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">platform_match</span><span class="params">(struct device *dev, struct device_driver *drv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> *<span class="title">pdev</span> =</span> to_platform_device(dev);</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> *<span class="title">pdrv</span> =</span> to_platform_driver(drv);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* When driver_override is set, only bind to the matching driver */</span></span><br><span class="line">  <span class="keyword">if</span> (pdev-&gt;driver_override)</span><br><span class="line">    <span class="keyword">return</span> !<span class="built_in">strcmp</span>(pdev-&gt;driver_override, drv-&gt;name);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* é¦–å…ˆå°è¯•è®¾å¤‡æ ‘åŒ¹é…(OF - Open Firmware Standard) */</span></span><br><span class="line">  <span class="keyword">if</span> (of_driver_match_device(dev, drv))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* ç„¶åå°è¯•åŒ¹é…é«˜çº§é…ç½®å’Œç”µæºæ¥å£</span></span><br><span class="line"><span class="comment">     (ACPI - https://baike.baidu.com/item/ACPI/299421?fr=aladdin)</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">if</span> (acpi_driver_match_device(dev, drv))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* ç„¶åå°è¯•åŒ¹é…IDè¡¨ */</span></span><br><span class="line">  <span class="keyword">if</span> (pdrv-&gt;id_table)</span><br><span class="line">    <span class="keyword">return</span> platform_match_id(pdrv-&gt;id_table, pdev) != <span class="literal">NULL</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* æœ€åå°è¯•åŒ¹é…é©±åŠ¨å’Œè®¾å¤‡çš„åç§° */</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="built_in">strcmp</span>(pdev-&gt;name, drv-&gt;name) == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä»¥ä¸Šä»£ç å¯ä»¥çœ‹å‡ºï¼Œå¹³å°æ€»çº¿çš„åŒ¹é…ç»è¿‡<code>è®¾å¤‡æ ‘ &gt; ACPI &gt; IDè¡¨ &gt; åç§°</code>ç­‰4ç§æ–¹å¼åŒ¹é…ï¼Œåªè¦ä»»æ„ä¸€ç§å±æ€§ç¡®è®¤è¿‡çœ¼ç¥ï¼Œå°±å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥ã€‚æ‰€ä»¥<code>led_driver</code>å’Œ<code>led_device</code>èƒ½å¤ŸåŒ¹é…ä¸Šï¼Œæ­£æ˜¯å› ä¸ºå®ƒä»¬å†…éƒ¨çš„<code>name</code>å€¼ç›¸åŒã€‚</p>
<p>æ¥ç€ï¼Œçœ‹çœ‹å¹³å°é©±åŠ¨å’Œå¹³å°è®¾å¤‡çš„æ•°æ®ç»“æ„ï¼Œä¸€åˆ‡å°±æ˜æœ—äº†ã€‚</p>
<p>åœ¨å¹³å°é©±åŠ¨çš„æ•°æ®ç»“æ„ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå®ƒå†…éƒ¨åŒ…å«äº†åº•å±‚çš„<code>device_driver</code>ç»“æ„ï¼Œå¦‚æœé©±åŠ¨æƒ³è¦åªæ˜¯æŸäº›ç±»å‹çš„è®¾å¤‡ï¼Œé‚£å°±å¿…é¡»åœ¨ç›¸åº”çš„ç”¨äºåŒ¹é…çš„å±æ€§é‡Œäº‹å…ˆå£°æ˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> (*probe)(struct platform_device *);</span><br><span class="line">  <span class="keyword">int</span> (*remove)(struct platform_device *);</span><br><span class="line">  <span class="keyword">void</span> (*shutdown)(struct platform_device *);</span><br><span class="line">  <span class="keyword">int</span> (*suspend)(struct platform_device *, <span class="keyword">pm_message_t</span> state);</span><br><span class="line">  <span class="keyword">int</span> (*resume)(struct platform_device *);</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">device_driver</span> <span class="title">driver</span>;</span>  <span class="comment">// åº•å±‚é©±åŠ¨æ•°æ®ç»“æ„</span></span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_device_id</span> *<span class="title">id_table</span>;</span> <span class="comment">// IDçš„åŒ¹é…è¡¨ğŸ‘ˆ</span></span><br><span class="line">  <span class="keyword">bool</span> prevent_deferred_probe;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_driver</span> &#123;</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span>        *name;      <span class="comment">// é©±åŠ¨åï¼Œç”¨äºåç§°åŒ¹é…ğŸ‘ˆ</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span>   *<span class="title">bus</span>;</span>       <span class="comment">// æ€»çº¿ç±»å‹ï¼Œå¦‚platform_bus</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">module</span>     *<span class="title">owner</span>;</span>     <span class="comment">// è¿™å°±ä¸è§£é‡Šäº†</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span>        *mod_name;  <span class="comment">// ç”¨äºæ„å»ºæ¨¡å—</span></span><br><span class="line">  <span class="keyword">bool</span> suppress_bind_attrs;  <span class="comment">/* disables bind/unbind via sysfs */</span></span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">probe_type</span> <span class="title">probe_type</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span>  *<span class="title">of_match_table</span>;</span>  <span class="comment">// è®¾å¤‡æ ‘çš„åŒ¹é…è¡¨ğŸ‘ˆ</span></span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">acpi_device_id</span>  *<span class="title">acpi_match_table</span>;</span> <span class="comment">// acpiçš„åŒ¹é…è¡¨ğŸ‘ˆ</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> (*probe) (struct device *dev);     <span class="comment">// æ¢æµ‹è®¾å¤‡ï¼šå½“åŒ¹é…æˆåŠŸæ—¶å›è°ƒ</span></span><br><span class="line">  <span class="keyword">int</span> (*remove) (struct device *dev);    <span class="comment">// ç§»é™¤è®¾å¤‡ï¼šå½“è®¾å¤‡å¸è½½æ—¶å›è°ƒ</span></span><br><span class="line">  <span class="keyword">void</span> (*shutdown) (struct device *dev); <span class="comment">// å…³é—­è®¾å¤‡</span></span><br><span class="line">  <span class="keyword">int</span> (*suspend) (struct device *dev, <span class="keyword">pm_message_t</span> state); <span class="comment">// æš‚åœ</span></span><br><span class="line">  <span class="keyword">int</span> (*resume) (struct device *dev);    <span class="comment">// æ¢å¤</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">groups</span>;</span></span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dev_pm_ops</span> *<span class="title">pm</span>;</span>           <span class="comment">// ç”µæºç®¡ç†</span></span><br><span class="line">  <span class="keyword">void</span> (*coredump) (struct device *dev); <span class="comment">// æ ¸å¿ƒè½¬å‚¨</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">driver_private</span> *<span class="title">p</span>;</span>              <span class="comment">// ç§æœ‰æ•°æ®</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å’Œå¹³å°é©±åŠ¨å¾ˆç±»ä¼¼ï¼Œå…¶å†…éƒ¨åŒæ ·åŒ…å«äº†åº•å±‚çš„<code>device</code>ç»“æ„ä½“ï¼Œå¦‚æœè®¾å¤‡æƒ³è¦è¢«æ€»çº¿åŒ¹é…ä¸Šï¼ŒåŒæ ·è¦åœ¨è‡ªå·±çš„å±æ€§é‡Œé…ç½®å¥½ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> &#123;</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span>    *name;    <span class="comment">// è®¾å¤‡åï¼Œä¸é©±åŠ¨çš„nameåŒ¹é… ğŸ‘ˆ</span></span><br><span class="line">  <span class="keyword">int</span>            id;       <span class="comment">// è®¾å¤‡ID</span></span><br><span class="line">  <span class="keyword">bool</span>          id_auto;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">device</span>  <span class="title">dev</span>;</span>      <span class="comment">// åº•å±‚æ•°æ®ç»“æ„</span></span><br><span class="line">  u32    num_resources;    <span class="comment">// è®¾å¤‡è¦ç”¨çš„èµ„æºæ•°é‡</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">resource</span>  *<span class="title">resource</span>;</span>  <span class="comment">// è®¾å¤‡çš„ç¡¬ä»¶èµ„æºæè¿°</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_device_id</span>  *<span class="title">id_entry</span>;</span>  <span class="comment">// è®¾å¤‡IDï¼Œä¸é©±åŠ¨çš„IDè¡¨åŒ¹é… ğŸ‘ˆ</span></span><br><span class="line">  <span class="keyword">char</span> *driver_override; <span class="comment">/* Driver name to force a match */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* MFD cell pointer */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">mfd_cell</span> *<span class="title">mfd_cell</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* arch specific additions */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pdev_archdata</span>  <span class="title">archdata</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å¥½äº†ï¼Œæœ¬æ–‡å¹¶ä¸æ‰“ç®—è¯¦ç»†è®¨è®ºæœ‰å…³å¹³å°ã€é©±åŠ¨ã€è®¾å¤‡åŠå…¶å¦‚ä½•åŒ¹é…çš„åŸç†ã€‚å¦‚æœå¯¹æ­¤æ„Ÿå…´è¶£æˆ–æƒ³è¦æ·±å…¥ç ”ç©¶ï¼Œè¯·ç”¨å¥½äº’è”ç½‘ã€‚æˆ‘ä¸ªäººä¹ŸæŸ¥äº†å¾ˆå¤šèµ„æ–™ï¼Œæ„Ÿè§‰è¿™ä½ä½œè€…å†™çš„<a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaojiang1025/p/6367061.html">ã€ŠLinux Platformé©±åŠ¨æ¨¡å‹(ä¸€) _è®¾å¤‡ä¿¡æ¯ã€‹</a>å’Œ<a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaojiang1025/archive/2017/02/06/6367910.html">ã€ŠLinux Platformé©±åŠ¨æ¨¡å‹(äºŒ) _é©±åŠ¨æ–¹æ³•ã€‹</a>è¿˜é˜”ä»¥ï¼Œé€‚åˆå…¥é—¨ã€‚</p>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“å¹³å°æ€»çº¿æä¾›äº†4ç§åŒ¹é…æ–¹æ³•ï¼Œ<code>name</code>åŒ¹é…å°±ä¸è¯´äº†ï¼Œå¦å¤–ä¸¤ç§ä¸æä¹Ÿç½¢ï¼Œæœ€æœ€æœ€é‡è¦çš„<code>è®¾å¤‡æ ‘</code>åŒ¹é…è¯¥ç™»åœºäº†ã€‚</p>
<h2 id="è®¾å¤‡æ ‘"><a href="#è®¾å¤‡æ ‘" class="headerlink" title="è®¾å¤‡æ ‘"></a>è®¾å¤‡æ ‘</h2><p>å…ˆå£°æ˜ï¼Œå…³äºè®¾å¤‡æ ‘çš„è¯­æ³•ã€æ ‘è“æ´¾çš„é…ç½®è§„åˆ™ï¼Œä¸ä¼šæ¶‰åŠå¤ªå¤šã€‚æœ¬æ–‡ä¾§é‡äºå®æˆ˜ï¼ŒåŸç†çŸ¥è¯†è¯·ç”¨å¥½äº’è”ç½‘ã€‚</p>
<p>ä»å†å²ä¸Šè¯´ï¼ŒARM-Linuxå¼•å…¥è®¾å¤‡æ ‘å®Œå…¨æ˜¯è¢«é€¼å‡ºæ¥çš„ã€‚æˆ‘ä»¬çŸ¥é“ARMä»¥IPæˆæƒçš„å•†ä¸šæ¨¡å¼è¿ä½œï¼Œè¯ç”Ÿäº†ä¼—å¤šèŠ¯ç‰‡å‚å•†ã€‚å®ƒä¸åƒx86/x64æ¶æ„åªæœ‰Intelä¹‹ç±»çš„å¯¡å¤´ï¼Œäº§å“å¤§åŒå°å¼‚æ¯”è¾ƒå¥½ç®¡ç†ã€‚armçš„æ±Ÿæ¹–å¯è°“é±¼é¾™æ··æ‚ï¼Œæ¯å®¶éƒ½æƒ³åœ¨Linuxå†…æ ¸ç§äº‰çš„ä¸€å¸­ä¹‹åœ°ã€‚å¯ååè¿™å¸®å®¶ä¼™æŠŠåˆæ˜¯ç¡¬ä»¶å‡ºç”Ÿï¼Œå¯¹äºå…¼å®¹è‡ªå®¶çš„ä¸åŒäº§å“åªä¼šç”¨<code>if-else</code>ï¼Œä½œä¸ºè½¯ä»¶å¤§ç¥çš„Linusè‡ªç„¶æ˜¯æ€’äº†ï¼šâ€œç­–ç•¥æ¨¡å¼â€éš¾é“ä¸é¦™ä¹ˆï¼Œä½ ä»¥ä¸ºç”¨Cå†™ä¸€å †â€œç”µè·¯æ¿è¯´æ˜ä¹¦â€å¾ˆé«˜çº§ä¹ˆï¼Ÿå¦‚æœä½ æ„¿æ„ï¼Œå¯ä»¥æµè§ˆä¸‹å†…æ ¸ç›®å½•<code>arch/arm/mach-xxx</code>ï¼Œéå¸¸å¤šå¯¹å§ã€‚å…¶å®è¿™äº›ç›®å½•å¤§å¤šæ˜¯SoCçš„ç¡¬ä»¶ç»†èŠ‚æè¿°ï¼Œç”¨äºé€‚é…å„å¤§å‚å•†ä¸åŒå‹å·çš„å¤„ç†å™¨æˆ–å¼€å‘æ¿ã€‚</p>
<p>é—²è¯å°±æ‰¯é‚£ä¹ˆå¤šï¼Œæ€»ä¹‹ï¼Œè®¾å¤‡æ ‘å°±æ˜¯ç”¨ç±»Cçš„æ–‡æœ¬è¯­è¨€ç¼–å†™ï¼Œç”¨äºæè¿°SocåŠå…¶å¤–å›´ç”µè·¯æ¨¡å—çš„é…ç½®æ–‡ä»¶ã€‚é€šå¸¸æƒ…å†µä¸‹å®ƒç”±bootloaderä¼ é€’ç»™å†…æ ¸ã€‚è¿™ç§åšæ³•ï¼Œæå¤§çš„é™ä½äº†é©±åŠ¨çš„ç»´æŠ¤éš¾åº¦ï¼Œä¹Ÿå¤§å¤§å¢åŠ äº†ç³»ç»Ÿè®¾å¤‡ç®¡ç†çš„çµæ´»æ€§ã€‚</p>
<p>âš ï¸åœ¨é˜…è¯»ä¸‹æ–‡å‰ï¼Œå¿…é¡»åŸºæœ¬æ‡‚å¾—ä¸¤ä¸ªçŸ¥è¯†ç‚¹ï¼š</p>
<ol>
<li>è®¾å¤‡æ ‘è¯­æ³•ï¼Œæˆ‘å°±ä¸å¤šå˜´äº†ï¼Œç½‘ä¸Šä¸€æœä¸€å¤§å †</li>
<li>æ ‘è“æ´¾overlayæœºåˆ¶ï¼Œè¿™ä¸ªç½‘ä¸Šå‡ ä¹æ²¡æœ‰ï¼Œæˆ‘åšä¸ªå¤§æ¦‚è¯´æ˜</li>
</ol>
<h3 id="æ ‘è“æ´¾çš„è®¾å¤‡æ ‘é…ç½®"><a href="#æ ‘è“æ´¾çš„è®¾å¤‡æ ‘é…ç½®" class="headerlink" title="æ ‘è“æ´¾çš„è®¾å¤‡æ ‘é…ç½®"></a>æ ‘è“æ´¾çš„è®¾å¤‡æ ‘é…ç½®</h3><p>æœ¬å°ç»“æ˜¯ä»ğŸ‘‰<a target="_blank" rel="noopener" href="https://www.raspberrypi.org/documentation/configuration/device-tree.md">æ ‘è“æ´¾DeviceTreeçš„å®˜æ–¹ä»‹ç»ä¸­</a>æ€»ç»“è€Œæ¥ï¼Œå¦‚æœæƒ³æ›´å…¨é¢åœ°äº†è§£ï¼Œå¯ä»¥çœ‹åŸæ–‡ã€‚</p>
<p>ä¸€ä¸ªå¸¸è§„çš„Arm-Linuxè®¾å¤‡æ ‘ï¼Œä¸»è¦æ˜¯ç”±æºæ–‡ä»¶<code>.dts</code>å’Œå¤´æ–‡ä»¶<code>.dtsi</code>å…±åŒç¼–è¯‘å‡º<code>.dtb</code>äºŒè¿›åˆ¶ï¼Œå†…æ ¸åœ¨åˆå§‹åŒ–åä¼šåŠ è½½è¿™ä¸ªdtbï¼Œå¹¶æŠŠç›¸å…³è®¾å¤‡éƒ½æ³¨å†Œå¥½ï¼Œå°±å¯ä»¥æ„‰å¿«åœ°ä½¿ç”¨äº†ã€‚ä¾‹å¦‚æ ‘è“æ´¾3B+ï¼Œ<code>/boot/bcm2710-rpi-3-b-plus.dtb</code>å°±æ˜¯æ ‘è“æ´¾SoCå’Œå¤–å›´ç”µè·¯çš„é»˜è®¤é…ç½®ã€‚</p>
<p>å¯¹äºå¤§éƒ¨åˆ†ç¡¬ä»¶äº§å“æ¥è¯´è¿™æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä¾‹å¦‚ä¸€éƒ¨æ‰‹æœºåœ¨å‡ºå‚ä»¥åï¼Œå®ƒçš„ç¡¬ä»¶å‡ ä¹æ˜¯ä¸ä¼šå˜çš„ã€‚ä½†å¯¹äºæ ‘è“æ´¾è¿™ç§å¼€å‘æ¿æ¥è¯´ï¼Œå°¤å…¶æ˜¯å®ƒçš„40pinæ‰©å±•å¼•è„šï¼Œå¤–å›´ç”µè·¯çš„å˜åŠ¨å¯å°±å¤§äº†å»äº†ï¼Œè€Œå†…æ ¸åŠ è½½<code>dtb</code>åæ˜¯ä¸èƒ½å˜çš„ï¼Œæ‰€ä»¥éœ€è¦ä¸€ç§<strong>åŠ¨æ€è¦†ç›–é…ç½®</strong>çš„è®¾å¤‡æ ‘æœºåˆ¶ï¼Œè¿™å°±æ˜¯æ ‘è“æ´¾çš„â€”â€”dtoverlay(è®¾å¤‡æ ‘è¦†ç›–)ã€‚</p>
<p>dtoverlayåŒæ ·æ˜¯ç”±dtsæºç¼–è¯‘è€Œæ¥ï¼Œè¯­æ³•å‡ ä¹å’Œè®¾å¤‡æ ‘ä¸€æ ·ï¼Œä¸è¿‡è¾“å‡ºæ–‡ä»¶æ‰©å±•åä¸º<code>dtbo</code>ã€‚æ ‘è“æ´¾æä¾›äº†ä¸¤ç§æ–¹å¼åŠ è½½dtboï¼š</p>
<ol>
<li>å°†ç¼–è¯‘å¥½çš„dtboæ”¾åˆ°<code>/boot/overlays</code>ä¸‹ï¼Œå¹¶ç”±<code>/boot/config.txt</code>é…ç½®å’Œä½¿èƒ½ï¼›</li>
<li>é€šè¿‡å‘½ä»¤<code>dtoverlay &lt;dtbo_file&gt;</code>åŠ¨æ€è¦†ç›–è®¾å¤‡æ ‘ï¼›</li>
</ol>
<p>ç¬¬1ç§æ–¹å¼ä¼šæ¶‰åŠæ›´å¤æ‚çš„è¯­æ³•è§„åˆ™ï¼Œæœ¬ç¯‡æ–‡ç« ä»…ä»…æ˜¯å¯¹å¹³å°è®¾å¤‡åŠè®¾å¤‡æ ‘çš„çŸ¥è¯†å…¥é—¨ï¼Œå› æ­¤é€‰æ‹©ç¬¬2ç§å‘½ä»¤è¡Œçš„æ–¹å¼ï¼ŒåŠ¨æ€åŠ è½½ã€‚</p>
<h3 id="ç”¨è®¾å¤‡æ ‘æ³¨å†Œè®¾å¤‡"><a href="#ç”¨è®¾å¤‡æ ‘æ³¨å†Œè®¾å¤‡" class="headerlink" title="ç”¨è®¾å¤‡æ ‘æ³¨å†Œè®¾å¤‡"></a>ç”¨è®¾å¤‡æ ‘æ³¨å†Œè®¾å¤‡</h3><p>led_driver.cï¼š<br>å…¶ä»–å†…å®¹ä¸å˜ï¼Œä»…ä»…æ˜¯å¢åŠ <code>of_device_id</code>å±æ€§ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¦–å…ˆç”¨of_device_idå£°æ˜äº†ä¸‰ç§LEDå‹å·çš„è¡¨ï¼Œæ”¯æŒè®¾å¤‡æ ‘è§£æ</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">of_leds_id</span>[] =</span> &#123;</span><br><span class="line">  &#123; .compatible = <span class="string">&quot;led_type_a&quot;</span> &#125;,</span><br><span class="line">  &#123; .compatible = <span class="string">&quot;led_type_b&quot;</span> &#125;,</span><br><span class="line">  &#123; .compatible = <span class="string">&quot;led_type_c&quot;</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">led_driver</span> =</span> &#123;</span><br><span class="line">  .probe = led_probe,</span><br><span class="line">  .remove = led_remove,</span><br><span class="line">  .driver = &#123;</span><br><span class="line">    .name = <span class="string">&quot;my_led&quot;</span>,</span><br><span class="line">    .of_match_table = of_leds_id, <span class="comment">// ğŸ‘ˆåœ¨é©±åŠ¨ç§æ·»åŠ å¯¹åº”å±æ€§</span></span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€æ–°å»ºä¸€ä¸ªè®¾å¤‡æ ‘æ–‡ä»¶ï¼Œå¹¶å®šä¹‰ä¸€ä¸ª<code>led_type_a</code>çš„LEDè®¾å¤‡ï¼Œå¹¶å°†å…¶å‘½åä¸º<code>led_a1</code>ã€‚</p>
<p>myled.dts</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/dts-v1/;</span><br><span class="line">/plugin/;</span><br><span class="line"></span><br><span class="line">/ &#123;</span><br><span class="line">  fragment@0 &#123;</span><br><span class="line">    target-path = &quot;/&quot;;</span><br><span class="line">    __overlay__ &#123;</span><br><span class="line">      led_a1 &#123;</span><br><span class="line">        compatible = &quot;led_type_a&quot;;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>fragment</code>å’Œ<code>__overlay__</code>éå¸¸é‡è¦ï¼ï¼å¦‚æœä¸è¿™ä¹ˆå†™ä¼šå¯¼è‡´åŠ¨æ€åŠ è½½å¤±è´¥ï¼Œä½†å…¶å®ä»¥ä¸Šçš„ä»£ç è½¬åŒ–ä¸ºæ ‡å‡†çš„è®¾å¤‡æ ‘è¯­æ³•ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/led_a1 &#123;</span><br><span class="line">  compatible = &quot;led_type_a&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æœ€åç”¨<code>dtc</code>ç¼–è¯‘å™¨å°†<code>dts</code>ç¼–è¯‘ä¸º<code>dtbo</code>ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">linux-rpi-4.19.y/scripts/dtc -I dts -o myled.dtbo myled.dts</span><br></pre></td></tr></table></figure>

<p>ä¸‡äº‹ä¿±å¤‡ï¼Œçœ‹çœ‹æ•ˆæœå§ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¬¬ä¸€æ­¥ï¼šåŠ è½½ledé©±åŠ¨</span></span><br><span class="line">philon@rpi:~/modules $ sudo insmod led_driver.ko </span><br><span class="line"><span class="comment"># ç¬¬äºŒæ­¥ï¼šåŠ è½½è®¾å¤‡æ ‘è¦†ç›–</span></span><br><span class="line">philon@rpi:~/modules $ sudo dtoverlay myled.dtbo</span><br><span class="line"><span class="comment"># ç¬¬ä¸‰éƒ¨ï¼šçœ‹çœ‹å¹³å°è®¾å¤‡é‡Œæ˜¯å¦æ³¨å†Œäº†ä¸€ä¸ªå«â€œled_a1â€çš„è®¾å¤‡</span></span><br><span class="line">philon@rpi:~/modules $ ls /sys/devices/platform/</span><br><span class="line">alarmtimer  Fixed MDIO bus.0    ğŸ‘‰led_a1ğŸ‘ˆ  power         serial8250  uevent</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ˜¾ç„¶å·²ç»æ³¨å†Œï¼Œæ ¹æ®led_driverçš„å®ç°ï¼Œè®¾å¤‡æ³¨å†Œåä¼šåœ¨probeå‡½æ•°ä¸­æ‰“å°ä¸€æ¡æ¶ˆæ¯</span></span><br><span class="line">philon@rpi:~/modules $ dmesg</span><br><span class="line">...</span><br><span class="line">[  429.359567] leddrv: no symbol version <span class="keyword">for</span> module_layout</span><br><span class="line">[  429.359577] leddrv: loading out-of-tree module taints kernel.</span><br><span class="line">[  435.995744] led led_a1 probe ğŸ‘ˆå•Šï½æˆ‘çœ‹åˆ°æ ‘ä¸Šé•¿äº†ä¸ªç¯</span><br></pre></td></tr></table></figure>

<p>å†æ¥å›é¡¾ä¸‹æµç¨‹ï¼š</p>
<ol>
<li>é¦–å…ˆé©±åŠ¨è¦æ”¯æŒ<code>of_device_id</code>å±æ€§ï¼Œå¹¶ä¸”ä»¥<code>compatible</code>ä½œä¸ºåŒ¹é…å¯¹è±¡</li>
<li>ç„¶åé€šè¿‡ç¼–å†™è®¾å¤‡æ ‘å®šä¹‰ç›¸åº”çš„è®¾å¤‡èµ„æº</li>
<li>æœ€åé€šè¿‡åŠ è½½é©±åŠ¨å’Œdtoverlayå³å¯</li>
</ol>
<h3 id="è®©è®¾å¤‡å¼€æœºè‡ªåŠ¨æ³¨å†Œ"><a href="#è®©è®¾å¤‡å¼€æœºè‡ªåŠ¨æ³¨å†Œ" class="headerlink" title="è®©è®¾å¤‡å¼€æœºè‡ªåŠ¨æ³¨å†Œ"></a>è®©è®¾å¤‡å¼€æœºè‡ªåŠ¨æ³¨å†Œ</h3><p>è¿™å°±éå¸¸ç®€å•äº†ï¼Œå‰é¢å·²ç»è¯´è¿‡<code>/boot/overlays</code>å…¶å®æ˜¯é€šè¿‡<code>config.txt</code>é…ç½®å’Œä½¿èƒ½çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å°†<code>myled.dtbo</code>æ”¾åˆ°overlaysç›®å½•ä¸‹ï¼Œå¹¶åœ¨config.txtæ·»åŠ ä¸€è¡Œä½¿èƒ½å³å¯ã€‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¬¬ä¸€æ­¥ï¼šå°†è‡ªå·±çš„dtboæ”¾åˆ°overlaysä¸‹</span></span><br><span class="line">philon@rpi:~/modules $ sudo cp myled.dtbo /boot/overlays</span><br><span class="line"><span class="comment"># ç¬¬äºŒæ­¥ï¼šåœ¨config.txtæœ€åä¸€è¡Œæ·»åŠ myled</span></span><br><span class="line">philon@rpi:~/modules $ sudo <span class="built_in">echo</span> <span class="string">&quot;dtoverlay=myled&quot;</span> | sudo tee -a /boot/config.txt</span><br><span class="line"><span class="comment"># ç¬¬ä¸‰æ­¥ï¼šreboot...</span></span><br><span class="line"><span class="comment"># ç¬¬å››æ­¥ï¼šå¯ä»¥åœ¨/sys/device/platformä¸‹æŸ¥çœ‹åˆ°è®¾å¤‡å·²ç»æ³¨å†Œ</span></span><br><span class="line">philon@rpi:~/modules $ ls /sys/devices/platform/</span><br><span class="line">alarmtimer  Fixed MDIO bus.0    ğŸ‘‰led_a1ğŸ‘ˆ  power         serial8250  uevent</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># âš ï¸ä½†æ˜¯ï¼Œè®¾å¤‡æ ‘ä»…ä»…æ˜¯å®šä¹‰äº†led_deviceï¼Œè€Œled_driver.koå…¶å®å¹¶æ²¡æœ‰å¼€æœºåŠ è½½ï¼Œå¦‚æœè¦æ›´å®Œå–„çš„è¯ï¼Œåº”è¯¥æŠŠled_driverç›´æ¥ç¼–è¯‘è¿›å†…æ ¸ï¼</span></span><br><span class="line">philon@rpi:~/modules $ sudo insmod leddrv.ko </span><br><span class="line">philon@rpi:~/modules $ dmesg</span><br><span class="line">...</span><br><span class="line">[  214.076752] leddrv: no symbol version <span class="keyword">for</span> module_layout</span><br><span class="line">[  214.076771] leddrv: loading out-of-tree module taints kernel.</span><br><span class="line">[  214.077535] led led_a1 probe</span><br></pre></td></tr></table></figure>

<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><ul>
<li>Linux-2.6åå¼•å…¥äº†<code>é©±åŠ¨-æ€»çº¿-è®¾å¤‡</code>çš„è½¯ä»¶æ¶æ„æ¥ç®¡ç†ç³»ç»Ÿè®¾å¤‡ï¼›</li>
<li><code>platform</code>è®¾å¤‡å’ŒUSBã€TTYã€UARTä¸€æ ·ï¼Œéƒ½æ˜¯åŸºäºåº•å±‚çš„æŠ½è±¡å’Œå°è£…ï¼›</li>
<li><code>platform</code>æ˜¯ä¸ºäº†æŠŠé‚£äº›æ²¡æœ‰æ€»çº¿çš„è®¾å¤‡ï¼Œä»¥æ€»çº¿çš„æ€æƒ³ç®¡ç†èµ·æ¥ï¼Œæ‰€ä»¥å®ƒç®—ä½œä¸€æ ¹è™šæ‹Ÿæ€»çº¿ï¼›</li>
<li>å¹³å°æ€»çº¿æä¾›äº†å¤šç§é©±åŠ¨å’Œè®¾å¤‡çš„åŒ¹é…è§„åˆ™ï¼šè®¾å¤‡æ ‘ã€ACPIã€IDè¡¨ã€åç§°ç­‰ï¼›</li>
<li>è®¾å¤‡æ ‘æ˜¯ç”±bootloaderä¼ é€’ç»™å†…æ ¸ï¼Œå¹¶ä¸”åœ¨åˆå§‹åŒ–ååŸºæœ¬ä¸å¯ä¿®æ”¹ï¼›</li>
<li>æ ‘è“æ´¾ä¸ºäº†æ»¡è¶³è®¾å¤‡æ ‘åŠ¨æ€ä¿®æ”¹çš„éœ€æ±‚ï¼Œå¼•å…¥äº†<code>dtoverlay</code>ï¼›</li>
<li>dtoverlayé‡‡ç”¨å¸¸è§„çš„è®¾å¤‡æ ‘è¯­æ³•ï¼Œä½†éœ€è¦<code>fragment</code>å’Œ<code>__overlay__</code>å±æ€§ï¼›</li>
<li>é©±åŠ¨å¿…é¡»å®šä¹‰<code>of_device_id</code>æ•°æ®ç»“æ„ï¼Œæ‰èƒ½ä¸è®¾å¤‡æ ‘åŒ¹é…ï¼›</li>
<li>åŠ¡å¿…æŒæ¡è®¾å¤‡æ ‘è¯­æ³•ï¼</li>
</ul>

    </div>

    
    
    
        <div class="reward-container">
  <div>å°å°é¼“åŠ±ï¼Œå¤§å¤§å¿ƒæ„ï¼</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    æ‰“èµ
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="Philon å¾®ä¿¡æ”¯ä»˜">
        <p>å¾®ä¿¡æ”¯ä»˜</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="Philon æ”¯ä»˜å®">
        <p>æ”¯ä»˜å®</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>æœ¬æ–‡ä½œè€…ï¼š </strong>Philon
  </li>
  <li class="post-copyright-link">
    <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
    <a href="https://ixx.life/RPiDriverInAction/07/" title="07ï¼šPDDä¸è®¾å¤‡æ ‘">https://ixx.life/RPiDriverInAction/07/</a>
  </li>
  <li class="post-copyright-license">
    <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ARM/" rel="tag"># ARM</a>
              <a href="/tags/Linux/" rel="tag"># Linux</a>
              <a href="/tags/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/" rel="tag"># é©±åŠ¨å¼€å‘</a>
              <a href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/" rel="tag"># åµŒå…¥å¼</a>
              <a href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" rel="tag"># æ ‘è“æ´¾</a>
              <a href="/tags/%E8%AE%BE%E5%A4%87%E6%A0%91/" rel="tag"># è®¾å¤‡æ ‘</a>
              <a href="/tags/%E6%80%BB%E7%BA%BF/" rel="tag"># æ€»çº¿</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/books/%E4%B8%8A%E5%B8%9D%E6%8E%B7%E9%AA%B0%E5%AD%90%E5%90%97/" rel="prev" title="è¯»ã€Šä¸Šå¸æ·éª°å­å—ï¼Ÿã€‹">
      <i class="fa fa-chevron-left"></i> è¯»ã€Šä¸Šå¸æ·éª°å­å—ï¼Ÿã€‹
    </a></div>
      <div class="post-nav-item">
    <a href="/97ThingsEveryProgrammerShouldKnow/59/" rel="next" title="é”™å¤±å¤šæ€çš„æœºä¼š">
      é”™å¤±å¤šæ€çš„æœºä¼š <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Philon"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Philon</p>
  <div class="site-description" itemprop="description">ä¸€ä¸ªç¨‹åºå‘˜çš„æˆé•¿è¶³è¿¹</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">177</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">77</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/philon" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;philon" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ixx.life</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'Y5scg9Ix4iae04UOae0uJSJA-gzGzoHsz',
      appKey     : 'U9hHApgNVDExYRJqXvUs5ykr',
      placeholder: "è¯´ç‚¹ä»€ä¹ˆå§...",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
