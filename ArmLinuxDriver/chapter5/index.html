<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo48x48.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo48x48.png">
  <link rel="mask-icon" href="/images/logo.png" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ixx.life","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="å¤äººäº‘:åˆ«è·Ÿè€å­è¯´ä»€ä¹ˆæ–­ç‚¹ã€è·Ÿè¸ªã€gdbã€lldbâ€¦è€å­è°ƒä»£ç ä»æ¥éƒ½æ˜¯printğŸ˜‚ï¸ã€‚è°ƒè¯•åœ¨ç¨‹åºå¼€å‘ä¸­æ˜¯éå¸¸é‡è¦çš„æ‰‹æ®µï¼Œå°±åƒå•å…ƒæµ‹è¯•ä¸€æ ·ï¼Œæ˜¯ä¿éšœè½¯ä»¶è´¨é‡çš„ä¸»è¦æ‰‹æ®µä¹‹ä¸€ï¼Œåˆ«ä¸å½“å›äº‹ï¼ è¨€å½’æ­£ä¼ ï¼Œlinuxå†…æ ¸æä¾›äº†å¤šç§è°ƒè¯•æŠ€æœ¯ï¼Œä½†å› ä¸ºé©±åŠ¨ç¨‹åºä¸æ˜¯æ™®é€šçš„ç¨‹åºï¼Œå¾ˆå¤šå¸¸è§çš„è°ƒè¯•å·¥å…·åˆ°å†…æ ¸è¿™ä¸€å±‚åŸºæœ¬éƒ½æ‰‘è¡—äº†ï¼Œprintkåè€Œæˆäº†æœ€æœ´å®æœ‰æ•ˆçš„æ‰‹æ®µä¹‹ä¸€ï¼Œä½†ä¸è®ºå¦‚ä½•ï¼Œå¤šæŒæ¡å…¶ä»–çš„è°ƒè¯•æ‰‹æ®µå’Œå·¥å…·ï¼Œå¯¹äºä»Šåå®šä½å†…æ ¸">
<meta property="og:type" content="article">
<meta property="og:title" content="äºŒï¼šè°ƒè¯•æŠ€æœ¯">
<meta property="og:url" content="https://ixx.life/ArmLinuxDriver/chapter5/index.html">
<meta property="og:site_name" content="è‡ªå¢äººç”Ÿ">
<meta property="og:description" content="å¤äººäº‘:åˆ«è·Ÿè€å­è¯´ä»€ä¹ˆæ–­ç‚¹ã€è·Ÿè¸ªã€gdbã€lldbâ€¦è€å­è°ƒä»£ç ä»æ¥éƒ½æ˜¯printğŸ˜‚ï¸ã€‚è°ƒè¯•åœ¨ç¨‹åºå¼€å‘ä¸­æ˜¯éå¸¸é‡è¦çš„æ‰‹æ®µï¼Œå°±åƒå•å…ƒæµ‹è¯•ä¸€æ ·ï¼Œæ˜¯ä¿éšœè½¯ä»¶è´¨é‡çš„ä¸»è¦æ‰‹æ®µä¹‹ä¸€ï¼Œåˆ«ä¸å½“å›äº‹ï¼ è¨€å½’æ­£ä¼ ï¼Œlinuxå†…æ ¸æä¾›äº†å¤šç§è°ƒè¯•æŠ€æœ¯ï¼Œä½†å› ä¸ºé©±åŠ¨ç¨‹åºä¸æ˜¯æ™®é€šçš„ç¨‹åºï¼Œå¾ˆå¤šå¸¸è§çš„è°ƒè¯•å·¥å…·åˆ°å†…æ ¸è¿™ä¸€å±‚åŸºæœ¬éƒ½æ‰‘è¡—äº†ï¼Œprintkåè€Œæˆäº†æœ€æœ´å®æœ‰æ•ˆçš„æ‰‹æ®µä¹‹ä¸€ï¼Œä½†ä¸è®ºå¦‚ä½•ï¼Œå¤šæŒæ¡å…¶ä»–çš„è°ƒè¯•æ‰‹æ®µå’Œå·¥å…·ï¼Œå¯¹äºä»Šåå®šä½å†…æ ¸">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-05-02T12:47:42.000Z">
<meta property="article:modified_time" content="2021-07-21T22:56:15.018Z">
<meta property="article:author" content="Philon">
<meta property="article:tag" content="ARM">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="é©±åŠ¨å¼€å‘">
<meta property="article:tag" content="åµŒå…¥å¼">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://ixx.life/ArmLinuxDriver/chapter5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>äºŒï¼šè°ƒè¯•æŠ€æœ¯ | è‡ªå¢äººç”Ÿ</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">è‡ªå¢äººç”Ÿ</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">ä½•ä»¥è§£å¿§ï¼Œå”¯æœ‰ i++</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-books">

    <a href="/books/" rel="section"><i class="fa  fa-book fa-fw"></i>è¯»ä¹¦å†™ä½œ</a>

  </li>
        <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-pen fa-fw"></i>å­¦ä¹ ç¬”è®°</a>

  </li>
        <li class="menu-item menu-item-leetcode">

    <a href="/leetcode/" rel="section"><i class="fa fa-fire fa-fw"></i>LeetCode</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ixx.life/ArmLinuxDriver/chapter5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Philon">
      <meta itemprop="description" content="ä¸€ä¸ªç¨‹åºå‘˜çš„æˆé•¿è¶³è¿¹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è‡ªå¢äººç”Ÿ">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          äºŒï¼šè°ƒè¯•æŠ€æœ¯
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-05-02 20:47:42" itemprop="dateCreated datePublished" datetime="2019-05-02T20:47:42+08:00">2019-05-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ARM-Linux%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">ARM-Linuxé©±åŠ¨å¼€å‘</span></a>
                </span>
            </span>

          
            <span id="/ArmLinuxDriver/chapter5/" class="post-meta-item leancloud_visitors" data-flag-title="äºŒï¼šè°ƒè¯•æŠ€æœ¯" title="é˜…è¯»æ¬¡æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/ArmLinuxDriver/chapter5/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/ArmLinuxDriver/chapter5/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>å¤äººäº‘:åˆ«è·Ÿè€å­è¯´ä»€ä¹ˆæ–­ç‚¹ã€è·Ÿè¸ªã€gdbã€lldbâ€¦è€å­è°ƒä»£ç ä»æ¥éƒ½æ˜¯printğŸ˜‚ï¸ã€‚è°ƒè¯•åœ¨ç¨‹åºå¼€å‘ä¸­æ˜¯éå¸¸é‡è¦çš„æ‰‹æ®µï¼Œå°±åƒå•å…ƒæµ‹è¯•ä¸€æ ·ï¼Œæ˜¯ä¿éšœè½¯ä»¶è´¨é‡çš„ä¸»è¦æ‰‹æ®µä¹‹ä¸€ï¼Œåˆ«ä¸å½“å›äº‹ï¼</p>
<p>è¨€å½’æ­£ä¼ ï¼Œlinuxå†…æ ¸æä¾›äº†å¤šç§è°ƒè¯•æŠ€æœ¯ï¼Œä½†å› ä¸ºé©±åŠ¨ç¨‹åºä¸æ˜¯æ™®é€šçš„ç¨‹åºï¼Œå¾ˆå¤šå¸¸è§çš„è°ƒè¯•å·¥å…·åˆ°å†…æ ¸è¿™ä¸€å±‚åŸºæœ¬éƒ½æ‰‘è¡—äº†ï¼Œprintkåè€Œæˆäº†æœ€æœ´å®æœ‰æ•ˆçš„æ‰‹æ®µä¹‹ä¸€ï¼Œä½†ä¸è®ºå¦‚ä½•ï¼Œå¤šæŒæ¡å…¶ä»–çš„è°ƒè¯•æ‰‹æ®µå’Œå·¥å…·ï¼Œå¯¹äºä»Šåå®šä½å†…æ ¸æ¨¡å—çš„é”™è¯¯ï¼Œæ€»ä¼šæœ‰å¸®åŠ©çš„ã€‚</p>
<h2 id="æ‰“å°-printk"><a href="#æ‰“å°-printk" class="headerlink" title="æ‰“å° - printk"></a>æ‰“å° - printk</h2><p><code>printk</code>å°±æ˜¯å¸¸è§„çš„æ‰“å°è¾“å‡ºï¼Œä½†ä¸åº”ç”¨æˆçš„<code>printf</code>ç¨å¾®ä¸åŒï¼Œå¾€å¾€ä¼šçœ‹åˆ°è¿™æ ·çš„è°ƒç”¨<code>printk(KERN_ALERT&quot;hello world&quot;)</code>ï¼Œå…¶ä¸­çš„<code>KERN_ALERT</code>è¡¨ç¤ºæ‰“å°çº§åˆ«ï¼Œå†…æ ¸æºç ä¸­å®šä¹‰äº†å¤šç§æ‰“å°çº§åˆ«ï¼Œä¸”çœ‹å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_SOH      <span class="meta-string">&quot;\001&quot;</span>       <span class="comment">/* ASCII Start Of Header */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_EMERG    KERN_SOH <span class="meta-string">&quot;0&quot;</span> <span class="comment">/* ç´§æ€¥äº‹ä»¶æ¶ˆæ¯,åœ¨ç³»ç»Ÿå´©æºƒå‰æç¤ºç”¨çš„ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_ALERT    KERN_SOH <span class="meta-string">&quot;1&quot;</span> <span class="comment">/* ç”¨äºéœ€è¦ç«‹å³é‡‡å–åŠ¨ä½œçš„æƒ…å†µ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_CRIT     KERN_SOH <span class="meta-string">&quot;2&quot;</span> <span class="comment">/* ä¸´ç•ŒçŠ¶æ€ï¼Œæ¶‰åŠä¸¥é‡çš„ç¡¬ä»¶æˆ–è½¯ä»¶æ“ä½œå¤±è´¥æ—¶æç¤º */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_ERR      KERN_SOH <span class="meta-string">&quot;3&quot;</span> <span class="comment">/* é”™è¯¯æŠ¥å‘Š */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_WARNING  KERN_SOH <span class="meta-string">&quot;4&quot;</span> <span class="comment">/* å¸¸è§„è­¦å‘Š */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_NOTICE   KERN_SOH <span class="meta-string">&quot;5&quot;</span> <span class="comment">/* æ™®é€šæç¤ºï¼Œå¸¸è§ä¸å®‰å…¨ç›¸å…³çš„æ±‡æŠ¥ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_INFO     KERN_SOH <span class="meta-string">&quot;6&quot;</span> <span class="comment">/* æç¤ºæ€§ä¿¡æ¯ï¼Œæ¯”å¦‚ç¡¬ä»¶ä¿¡æ¯ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_DEBUG    KERN_SOH <span class="meta-string">&quot;7&quot;</span> <span class="comment">/* è°ƒè¯•ä¿¡æ¯ */</span></span></span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šå®šä¹‰å¯ä»¥çœ‹åˆ°ï¼Œå†…æ ¸å…±æä¾›äº†0-7ä¸ªçº§åˆ«ï¼Œ<strong>æ•°å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜</strong>ã€‚</p>
<h3 id="å±è”½å…¶ä»–çº§åˆ«æ‰“å°"><a href="#å±è”½å…¶ä»–çº§åˆ«æ‰“å°" class="headerlink" title="å±è”½å…¶ä»–çº§åˆ«æ‰“å°"></a>å±è”½å…¶ä»–çº§åˆ«æ‰“å°</h3><p><code>/proc/sys/kernel/printk</code>æ–‡ä»¶å¾ˆé‡è¦ï¼Œå¯ä»¥é€šè¿‡å®ƒæ¥å±è”½ä¸åŒçº§åˆ«çš„æ‰“å°è¾“å‡ºï¼Œæˆ‘ä»¬è¿…é€Ÿå†™ä¸€æ®µä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">meme_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_EMERG<span class="string">&quot;emerg 0\n&quot;</span>);</span><br><span class="line">    printk(KERN_ALERT<span class="string">&quot;alert 1\n&quot;</span>);</span><br><span class="line">    printk(KERN_CRIT<span class="string">&quot;crit 2\n&quot;</span>);</span><br><span class="line">    printk(KERN_ERR<span class="string">&quot;err 3\n&quot;</span>);</span><br><span class="line">    printk(KERN_WARNING<span class="string">&quot;warning 4\n&quot;</span>);</span><br><span class="line">    printk(KERN_NOTICE<span class="string">&quot;notice 5\n&quot;</span>);</span><br><span class="line">    printk(KERN_INFO<span class="string">&quot;info 6\n&quot;</span>);</span><br><span class="line">    printk(KERN_DEBUG<span class="string">&quot;debug 7\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">module_init(meme_init);</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šä»£ç åªæ˜¯åœ¨æ¨¡å—åŠ è½½çš„æ—¶å€™æ‰“å°äº†7ä¸ªçº§åˆ«çš„å†…å®¹ï¼Œç°åœ¨åšä¸€ä»¶äº‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹è¯¥æ–‡ä»¶å‘ç°é»˜è®¤æ‰“å°çº§åˆ«å°äº7ï¼Œå³é™¤äº†KERN_DEBUGçº§åˆ«ï¼Œå…¶ä»–éƒ½èƒ½æ˜¾ç¤ºåˆ°ç»ˆç«¯</span></span><br><span class="line">/ <span class="comment"># cat /proc/sys/kernel/printk</span></span><br><span class="line">7	4	1	7</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç°åœ¨å¼ºåˆ¶æ‰“å°çº§åˆ«å°äº3ï¼Œå³KERN_ERRåŠå…¶ä¹‹åçº§åˆ«çš„å†…å®¹ä¸å†æ˜¾ç¤º</span></span><br><span class="line">/ <span class="comment"># echo 3 &gt; /proc/sys/kernel/printk</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½æ¨¡å—</span></span><br><span class="line">/ <span class="comment"># insmod meme.ko </span></span><br><span class="line">emerg 0</span><br><span class="line">alert 1</span><br><span class="line">crit 2</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šè¾¹çš„æŒ‡ä»¤å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ä¿®æ”¹/proc/sys/kernel/printkæ–‡ä»¶çš„å€¼å¯ä»¥ç›´æ¥å¼ºåˆ¶æ§åˆ¶å°æ‰“å°çš„æ—¥å¿—çº§åˆ«ï¼Œè¿™å¯è¦æ¯”ä½ åå¤æ³¨é‡Š+ç¼–è¯‘çš„æ‰‹æ®µé«˜æ˜å¤šäº†ã€‚</p>
<h2 id="é€šè¿‡procfsæ–‡ä»¶æŸ¥è¯¢è°ƒè¯•"><a href="#é€šè¿‡procfsæ–‡ä»¶æŸ¥è¯¢è°ƒè¯•" class="headerlink" title="é€šè¿‡procfsæ–‡ä»¶æŸ¥è¯¢è°ƒè¯•"></a>é€šè¿‡procfsæ–‡ä»¶æŸ¥è¯¢è°ƒè¯•</h2><p>printkå‡½æ•°å›ºç„¶ç®€å•æ˜“ç”¨ï¼Œä½†é™¤äº†é€¼æ ¼å¾ˆlowä¹‹å¤–è¿˜å­˜åœ¨ä¸ªæŠ€æœ¯ä¸Šçš„éšœç¢â€”â€”å¤§é‡ä½¿ç”¨printkä¼šæå¤§åœ°æ‹–ç´¯ç¨‹åºçš„æ€§èƒ½ï¼ŒåŸåˆ™ä¸Šä¹Ÿä»…ç”¨äºå¸¸è§„å’Œé”™è¯¯ä¿¡æ¯æç¤ºï¼Œåƒforã€whileä¹‹ç±»çš„å¾ªç¯å†…åƒä¸‡åˆ«ç”¨å®ƒã€‚</p>
<p>ç„¶è€Œå®é™…ä¸Šç”¨æˆ·éœ€è¦æ—¶åˆ»æŒæ¡å„ç§è®¾å¤‡çš„çŠ¶æ€ä¿¡æ¯ï¼Œæ¯”å¦‚cpuå½“å‰é¢‘ç‡/æ¸©åº¦ã€å†…å­˜å ç”¨ç‡ç­‰ç­‰ï¼Œprintkæ˜¾ç„¶ä¸èƒ½èƒœä»»ï¼Œè½®åˆ°procfsç™»åœºäº†ï¼Œæˆ‘ä»¬çŸ¥é“procæ˜¯å†…æ ¸çš„ä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œèƒ½å¤Ÿä»¥æ–‡ä»¶çš„å½¢å¼å±•ç°æ•´ä¸ªç³»ç»Ÿå†…éƒ¨çš„ä¿¡æ¯ï¼Œè€Œ<strong>é€šè¿‡procfsæ–‡ä»¶æŸ¥è¯¢è°ƒè¯•</strong>æŠ€æœ¯ï¼Œå°±æ˜¯åœ¨<code>/proc</code>ç›®å½•ä¸‹åˆ›å»ºé©±åŠ¨æ¨¡å—è‡ªå·±çš„ç›®å½•å’Œæ–‡ä»¶â€”â€”ä¿—ç§°å…¥å£ï¼Œä¾›ç”¨æˆ·éšæ—¶è®¿é—®ã€‚</p>
<p>æˆ‘ä¸ªäººè§‰å¾—ï¼Œé©±åŠ¨æš´éœ²åœ¨procæ–‡ä»¶ç³»ç»Ÿçš„å…¥å£å…¶å®å¾ˆå°‘ä¼šç”¨äºâ€œè°ƒè¯•â€ï¼Œè€Œæ˜¯ä¸€äº›å…³é”®ä¿¡æ¯çš„å±•ç¤ºï¼Œæ¯”å¦‚<code>cpuinfo</code>ã€<code>meminfo</code>ç­‰æ–‡ä»¶ï¼Œè¿™å°±æ˜¯å…¸å‹çš„åº”ç”¨åœºæ™¯ï¼Œcpuå’Œå†…å­˜é©±åŠ¨åˆ›å»ºçš„æ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥æŸ¥çœ‹ç›¸å…³è®¾å¤‡çš„ç»†èŠ‚ä¿¡æ¯ã€‚</p>
<p>åœ¨<code>proc</code>æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºå…¥å£æ–‡ä»¶éå¸¸ç®€å•ï¼Œæ€»å…±æœ‰ä¸¤ç§å½¢å¼ï¼š</p>
<h3 id="1-æ™®é€šprocå…¥å£"><a href="#1-æ™®é€šprocå…¥å£" class="headerlink" title="1. æ™®é€šprocå…¥å£"></a>1. æ™®é€šprocå…¥å£</h3><p>ä¹‹å‰çš„å­¦ä¹ ç¬”è®°ä¸­ï¼Œæˆ‘ä»¬å·²ç»åˆ›å»ºäº†memeé©±åŠ¨æ¨¡å—çš„è®¾å¤‡èŠ‚ç‚¹<code>/dev/meme</code>ï¼Œç°åœ¨å®ç°ä¸€ä¸ªæ–°åŠŸèƒ½ï¼Œç”¨æˆ·åªéœ€è¦é€šè¿‡å‘½ä»¤<code>cat /proc/meme/state</code>å³å¯æŸ¥çœ‹è®¾å¤‡èŠ‚ç‚¹<code>/dev/meme</code>çš„æ–‡ä»¶è®¿é—®çŠ¶æ€ï¼Œä¾‹å¦‚æ‰“å¼€ã€å…³é—­ã€æ­£åœ¨è¯»ã€æ­£åœ¨å†™ç­‰ç­‰ã€‚</p>
<p>é¦–å…ˆï¼Œåœ¨procfsåˆ›å»º/åˆ é™¤å…¥å£æ–‡ä»¶çš„APIæœ‰è¿™ä¹ˆå‡ ä¸ªï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// procå…¥å£æ–‡ä»¶çš„ç»“æ„ä½“å®šä¹‰</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proc_dir_entry</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨procfsä¸‹åˆ›å»ºä¸€ä¸ªç›®å½•</span></span><br><span class="line"><span class="comment">// @name    è¦åˆ›å»ºçš„ç›®å½•å</span></span><br><span class="line"><span class="comment">// @parent  ä¸Šçº§ç›®å½•ï¼ŒNULLè¡¨ç¤º/proc</span></span><br><span class="line"><span class="function">struct proc_dir_entry *<span class="title">proc_mkdir</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, struct proc_dir_entry *parent)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨procfsä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶</span></span><br><span class="line"><span class="comment">// @name    è¦åˆ›å»ºçš„æ–‡ä»¶å</span></span><br><span class="line"><span class="comment">// @mode    æ–‡ä»¶çš„è®¿é—®æƒé™</span></span><br><span class="line"><span class="comment">// @parent  æ‰€åœ¨ç›®å½•ï¼ŒNULLè¡¨ç¤º/proc</span></span><br><span class="line"><span class="comment">// @proc_fops æ–‡ä»¶æ“ä½œç»“æ„ï¼Œä¸å­—ç¬¦è®¾å¤‡ä¸€æ ·çš„æœºåˆ¶</span></span><br><span class="line"><span class="function">struct proc_dir_entry *<span class="title">proc_create</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">umode_t</span> mode, struct proc_dir_entry *parent, <span class="keyword">const</span> struct file_operations *proc_fops)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨procfsä¸‹åˆ é™¤ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•</span></span><br><span class="line"><span class="comment">// @name    è¦åˆ é™¤çš„å…¥å£å</span></span><br><span class="line"><span class="comment">// @parent  æ‰€åœ¨ä¸Šçº§ç›®å½•</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">remove_proc_entry</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, struct proc_dir_entry *parent)</span></span>;</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œé€šè¿‡è°ƒç”¨<code>proc_mkdir()</code>å’Œ<code>proc_create()</code>å³å¯åˆ›å»ºå‡º<code>/proc/meme/state</code>ç›®å½•å’Œæ–‡ä»¶äº†ï¼Œå‡ ä¹æ²¡ä»€ä¹ˆéš¾åº¦ï¼Œæ³¨æ„åœ¨åˆ›å»ºprocçš„å…¥å£æ–‡ä»¶æ—¶éœ€è¦æŒ‡å®šä¸€ä¸ª<code>file_operations *fops</code>ï¼Œå…¶å®å°±æ˜¯æ–‡ä»¶è®¿é—®å‡½æ•°çš„æ˜ å°„ï¼Œå’Œå­—ç¬¦è®¾å¤‡ç« èŠ‚ä¸­çš„æ“ä½œä¸€æ¨¡ä¸€æ ·ã€‚è€Œ<code>/proc/meme/state</code>æ˜¯ä¸€ä¸ªåªè¯»çŠ¶æ€æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å®ç°<code>read</code>å‡½æ•°çš„åŠŸèƒ½â€”â€”è¿”å›çŠ¶æ€å­—ç¬¦ä¸²ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * meme_proc.c</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¨å±€å˜é‡ï¼Œmemeçš„è®¾å¤‡èŠ‚ç‚¹çŠ¶æ€</span></span><br><span class="line"><span class="keyword">int</span> meme_cdev_state = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">meme_proc_read</span><span class="params">(struct file* filp, <span class="keyword">char</span> __user* buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span>* off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* state = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*off &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (meme_cdev_state) &#123;</span><br><span class="line">        <span class="keyword">case</span> MEME_STATE_OPENED: state = <span class="string">&quot;opened&quot;</span>; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MEME_STATE_CLOSED: state = <span class="string">&quot;closed&quot;</span>; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MEME_STATE_READING: state = <span class="string">&quot;reading&quot;</span>; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MEME_STATE_WRITING: state = <span class="string">&quot;writing&quot;</span>; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>: state = <span class="string">&quot;unknown&quot;</span>; <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    len = <span class="built_in">strlen</span>(state);</span><br><span class="line">    <span class="keyword">if</span> ((rc = copy_to_user(buf, state, len)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line">    buf[len++] = <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">    buf[len++] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»‘å®šç”¨æˆ·å±‚readæ—¶çš„è§¦å‘å‡½æ•°</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">proc_fops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .read = meme_proc_read,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// procfså…¥å£ç›®å½•</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proc_dir_entry</span>* <span class="title">meme_proc_entry</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> __init <span class="title">meme_proc_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// å³/proc/meme/stateï¼Œç”¨äºè®°å½•è®¾å¤‡æè¿°ç¬¦/dev/memeçš„æ–‡ä»¶è®¿é—®çŠ¶æ€</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proc_dir_entry</span>* <span class="title">meme_state_file</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºmemeæ¨¡å—çš„procç›®å½•ï¼Œå³/proc/meme/</span></span><br><span class="line">    meme_proc_entry = proc_mkdir(<span class="string">&quot;meme&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (meme_proc_entry == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»º/proc/meme/stateæ–‡ä»¶ï¼Œä¸”è¯¥æ–‡ä»¶ä¸ºåªè¯»</span></span><br><span class="line">    meme_state_file = proc_create(<span class="string">&quot;state&quot;</span>, <span class="number">0500</span>, meme_proc_entry, &amp;proc_fops);</span><br><span class="line">    <span class="keyword">if</span> (meme_state_file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> __exit <span class="title">meme_proc_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// å¸è½½æ¨¡å—æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤æ‰€æœ‰/proc/memeæ‰€åˆ›å»ºçš„æ–‡ä»¶åŠç›®å½•</span></span><br><span class="line">    remove_proc_entry(<span class="string">&quot;state&quot;</span>, meme_proc_entry);</span><br><span class="line">    remove_proc_entry(<span class="string">&quot;meme&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šæ˜¯memeé©±åŠ¨æ¨¡å—åœ¨procå…¥å£çŠ¶æ€æ–‡ä»¶çš„ç›¸å…³å®ç°ï¼Œæ—¢ç„¶è¦ç›‘å¬çš„æ˜¯<code>/dev/meme</code>è®¾å¤‡èŠ‚ç‚¹çš„è®¿é—®çŠ¶æ€ï¼Œä¸Šè¿°ä»£ç æ˜¯é€šè¿‡<code>meme_cdev_state</code>å…¨å±€å˜é‡æ¥å®ç°çš„ï¼Œæ•…è¿™è¾¹å˜é‡è‡ªç„¶æ˜¯åœ¨å­—ç¬¦è®¾å¤‡çš„ä»£ç å®ç°ä¸­è¢«ä¿®æ”¹çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * main.c</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">meme_read</span><span class="params">(struct file* filp, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span>* off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    meme_cdev_state = MEME_STATE_READING;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">meme_write</span><span class="params">(struct file* filp, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span>* off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    meme_cdev_state = MEME_STATE_WRITING;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">meme_open</span><span class="params">(struct inode* inode, struct file* filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    meme_cdev_state = MEME_STATE_OPENED;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">meme_close</span><span class="params">(struct inode* inode, struct file* filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    meme_cdev_state = MEME_STATE_CLOSED;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æ­¤ä¸€æ¥ï¼Œç”¨æˆ·è®¿é—®<code>/dev/meme</code>è®¾å¤‡èŠ‚ç‚¹ï¼Œ<code>meme_cdev_state</code>å€¼å°±ä¼šè¢«æ”¹å˜ï¼Œå¯¹åº”çš„çŠ¶æ€è‡ªç„¶å°±æš´éœ²åˆ°<code>/proc/meme/state</code>çš„readè§¦å‘å‡½æ•°ä¸­äº†ï¼Œå®Œç¾ï½</p>
<p>æµ‹è¯•ä¸€ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># insmod meme.ko </span></span><br><span class="line">meme: loading out-of-tree module taints kernel.</span><br><span class="line">meme init: 250:0</span><br><span class="line">/ <span class="comment"># mknod /dev/meme c 250 0</span></span><br><span class="line">/ <span class="comment"># while true; do echo 123 &gt;&gt; /dev/meme; done &amp;</span></span><br><span class="line">/ <span class="comment"># cat /proc/meme/state </span></span><br><span class="line">opened</span><br><span class="line">/ <span class="comment"># cat /proc/meme/state </span></span><br><span class="line">closed</span><br><span class="line">/ <span class="comment"># cat /proc/meme/state </span></span><br><span class="line">opened</span><br><span class="line">/ <span class="comment"># cat /proc/meme/state </span></span><br><span class="line">writing</span><br></pre></td></tr></table></figure>

<h3 id="2-seq-fileæ¥å£"><a href="#2-seq-fileæ¥å£" class="headerlink" title="2. seq_fileæ¥å£"></a>2. seq_fileæ¥å£</h3><p><code>seq_file</code>ä¸»è¦æ˜¯ç”¨äºå¤„ç†é‚£äº›æ¯”è¾ƒâ€œå¤§â€çš„procå…¥å£æ–‡ä»¶ã€‚æ‰€è°“çš„å¤§ä¸æ˜¯è¯´æ–‡ä»¶ä½“ç§¯ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œå½“æˆ‘ä»¬éœ€è¦å¼€å‘ä¸€ä¸ªä¸²å£é©±åŠ¨ï¼Œè€Œè¿™ä¸ªé©±åŠ¨éœ€è¦è®°å½•ä¸²å£æ¯ä¸€æ¬¡çš„æ”¶å‘å†å²è®°å½•ï¼Œç”¨è¿™ç§æ–¹å¼å†ä½•æ—¶ä¸è¿‡ã€‚seqæ˜¯åºåˆ—çš„æ„æ€ï¼Œå³é€šè¿‡è¿­ä»£çš„æ–¹å¼ï¼ŒæŠŠé©±åŠ¨çš„æŸäº›çŠ¶æ€ä¿¡æ¯æŒ‰é¡ºåºæ‰“å°å‡ºæ¥ã€‚</p>
<p><code>seq_file</code>æä¾›äº†4ä¸ªè¿­ä»£å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">    <span class="comment">// é¦–æ¬¡è®¿é—®æ—¶è§¦å‘</span></span><br><span class="line">	<span class="keyword">void</span> * (*start) (struct seq_file *m, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="comment">// ç»“æŸè®¿é—®æ—¶è§¦å‘</span></span><br><span class="line">	<span class="keyword">void</span> (*stop) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">    <span class="comment">// è¿­ä»£è®¿é—®æ—¶è§¦å‘</span></span><br><span class="line">	<span class="keyword">void</span> * (*next) (struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="comment">// æ‰“å°å±•ç¤ºæ—¶è§¦å‘</span></span><br><span class="line">	<span class="keyword">int</span> (*show) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨å†åˆ›å»ºä¸€ä¸ªå…¥å£æ–‡ä»¶<code>/proc/meme/info</code>ï¼Œå½“ç”¨æˆ·é€šè¿‡å‘½ä»¤<code>cat /proc/meme/info</code>æ—¶ï¼Œæ‰“å°0-100è¡Œè®¡æ•°å†…å®¹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * meme_seq_file.c</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/seq_file.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXNUM 100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¿é—®æ–‡ä»¶æ—¶é¦–å…ˆè°ƒç”¨çš„æ¥å£</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span>* <span class="title">meme_seq_start</span><span class="params">(struct seq_file* m, <span class="keyword">loff_t</span>* pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span>* v = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (*pos &lt; MAXNUM) &#123;</span><br><span class="line">        v = kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">int</span>), GFP_KERNEL);</span><br><span class="line">        *v = *pos;</span><br><span class="line">        seq_printf(m, <span class="string">&quot;start: *(%p) = %d\n&quot;</span>, v, *(<span class="keyword">int</span>*)v);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// startå‡½æ•°è¿”å›NULLè¡¨ç¤ºposå·²åˆ°è¾¾æ–‡ä»¶æœ«å°¾</span></span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¯æ¬¡è¿­ä»£æ—¶è°ƒç”¨ï¼Œå…¶ä¸­væ˜¯ä¹‹å‰ä¸€æ¬¡è¿­ä»£(startæˆ–next)çš„è¿”å›å€¼</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span>* <span class="title">meme_seq_next</span><span class="params">(struct seq_file* m, <span class="keyword">void</span>* v, <span class="keyword">loff_t</span>* pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> num = *(<span class="keyword">int</span>*)v;</span><br><span class="line">    <span class="keyword">if</span> (num++ &gt;= MAXNUM) &#123;</span><br><span class="line">        <span class="comment">// è¿”å›NULLåœæ­¢è¿­ä»£</span></span><br><span class="line">        kfree(v);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¯æ¬¡è¿­ä»£ï¼Œvå’Œæ–‡ä»¶æ¸¸æ ‡éƒ½å¢åŠ 1</span></span><br><span class="line">    *(<span class="keyword">int</span>*)v = *pos = num;</span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»“æŸè¿­ä»£æ—¶è°ƒç”¨ï¼Œå¦‚æœåœ¨startä¸­æœ‰å†…å­˜åˆ†é…ï¼Œåº”è¯¥åœ¨è¿™é‡Œè¿›è¡Œå†…å­˜æ¸…ç†</span></span><br><span class="line"><span class="comment">// ä½†ç”±äºnextçš„æœ€åä¸€æ¬¡è¿­ä»£è‚¯å®šè¿”å›NULLï¼Œæ‰€ä»¥è¿™é‡Œçš„våœ°å€ä¸€å®šä¸ºNULL</span></span><br><span class="line"><span class="comment">// ä¸éœ€è¦ä½œä»»ä½•å¤„ç†</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">meme_seq_stop</span><span class="params">(struct seq_file* m, <span class="keyword">void</span>* v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å±•ç¤ºæ—¶è°ƒç”¨ï¼Œä¸»è¦æ˜¯å°†vçš„å†…å®¹æ ¼å¼åŒ–å¹¶è¾“å‡ºåˆ°ç”¨æˆ·ç©ºé—´</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">meme_seq_show</span><span class="params">(struct seq_file* m, <span class="keyword">void</span>* v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    seq_printf(m, <span class="string">&quot;show: *(%p) = %d\n&quot;</span>, v, *(<span class="keyword">int</span>*)v);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ˜ å°„seqçš„startã€nextã€stopã€showå››ä¸ªè¿­ä»£å™¨çš„å‡½æ•°</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> <span class="title">meme_seq_ops</span> =</span> &#123;</span><br><span class="line">    .start = meme_seq_start,</span><br><span class="line">    .next = meme_seq_next,</span><br><span class="line">    .stop = meme_seq_stop,</span><br><span class="line">    .show = meme_seq_show,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">meme_seq_open</span><span class="params">(struct inode* inode, struct file* filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ç»‘å®šè¿­ä»£æ“ä½œçš„4ä¸ªå‡½æ•°åˆ°/proc/meme/infoæ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">return</span> seq_open(filp, &amp;meme_seq_ops);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// /proc/meme/infoçš„æ–‡ä»¶æ“ä½œæ˜ å°„ï¼Œé™¤äº†openéœ€è¦è‡ªå·±å®ç°å¤–ï¼Œå…¶ä»–å‡ä½¿ç”¨å†…éƒ¨å®šä¹‰å¥½çš„</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">meme_seq_fops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .open = meme_seq_open,</span><br><span class="line">    .read = seq_read,</span><br><span class="line">    .llseek = seq_lseek,</span><br><span class="line">    .release = seq_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> __init <span class="title">meme_seq_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºseqå…¥å£æ–‡ä»¶ï¼Œå³/proc/meme/infoï¼Œå¹¶ç»‘å®šseqç›¸å…³æ–‡ä»¶å‡½æ•°</span></span><br><span class="line">    proc_create(<span class="string">&quot;info&quot;</span>, <span class="number">0500</span>, meme_proc_entry, &amp;meme_seq_fops);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> __exit <span class="title">meme_seq_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// åˆ é™¤/proc/meme/infoæ–‡ä»¶</span></span><br><span class="line">    remove_proc_entry(<span class="string">&quot;info&quot;</span>, meme_proc_entry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šè¾¹çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†å®ç°4ä¸ªè¿­ä»£çš„è§¦å‘å‡½æ•°ä¹‹å¤–ï¼Œè¿˜éœ€è¦å®ç°æ–‡ä»¶çš„openè§¦å‘ï¼Œå‰©ä¸‹çš„å†…å®¹å°±å’Œå¸¸è§„çš„procå…¥å£æ–‡ä»¶åˆ›å»ºæœºåˆ¶æ²¡ä»€ä¹ˆåŒºåˆ«äº†ã€‚æµ‹è¯•ä¸€ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># insmod meme.ko</span></span><br><span class="line">/ <span class="comment"># cat /proc/meme/info</span></span><br><span class="line">start: *(ada2e682) = 0</span><br><span class="line">show: *(ada2e682) = 0</span><br><span class="line">show: *(ada2e682) = 1</span><br><span class="line">show: *(ada2e682) = 2</span><br><span class="line">show: *(ada2e682) = 3</span><br><span class="line">...</span><br><span class="line">show: *(ada2e682) = 99</span><br><span class="line">show: *(ada2e682) = 100</span><br></pre></td></tr></table></figure>

<p>ä»£ç å®ç°çš„æ¯”è¾ƒç®€å•ï¼Œåœ¨<code>start</code>å‡½æ•°ä¸­ä¸ºè¿­ä»£åˆ†é…ä¸€æ®µå†…å®¹ç©ºé—´ç”¨äºè®¡æ•°ï¼Œè€Œåœ¨<code>next</code>æ¯æ¬¡è¿­ä»£æ—¶å°†è®¡æ•°ç´¯åŠ 1ç›´åˆ°100åè·³å‡ºè¿­ä»£ï¼Œæ¯æ¬¡è¿­ä»£åéƒ½ä¼šè‡ªåŠ¨è°ƒç”¨<code>show</code>å°†è®°å½•å€¼æ‰“å°å‡ºæ¥ã€‚</p>
<h2 id="é€šè¿‡straceå‘½ä»¤ç›‘è§†"><a href="#é€šè¿‡straceå‘½ä»¤ç›‘è§†" class="headerlink" title="é€šè¿‡straceå‘½ä»¤ç›‘è§†"></a>é€šè¿‡straceå‘½ä»¤ç›‘è§†</h2><h3 id="straceç§»æ¤"><a href="#straceç§»æ¤" class="headerlink" title="straceç§»æ¤"></a>straceç§»æ¤</h3><p>ç”±äºBusyboxé»˜è®¤æ˜¯ä¸å¸¦straceçš„ï¼Œéœ€è¦è‡ªè¡Œç§»æ¤ã€‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½straceæºç å¹¶ç§»æ¤</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/strace/strace.git</span><br><span class="line">$ <span class="built_in">cd</span> strace &amp;&amp; ./bootstrap</span><br><span class="line">$ mkdir build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">$ ../configure prefix=$(<span class="built_in">pwd</span>)/install --host=arm-linux-gnueabihf CC=arm-linux-gnueabihf-gcc</span><br><span class="line">$ make -j8 &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†straceå‘½ä»¤æ‹·è´è‡³ç›®æ ‡æ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">$ sudo mount -o loop ../../rootfs.ext3 /mnt/</span><br><span class="line">$ sudo cp install/bin/strace /mnt/usr/bin</span><br><span class="line">$ sudo umount /mnt</span><br></pre></td></tr></table></figure>

<p>å‚ç…§å®˜æ–¹æ–‡æ¡£æµ‹è¯•ä¸€ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># strace -c ls &gt; /dev/null </span></span><br><span class="line">% time     seconds  usecs/call     calls    errors syscall</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line"> 33.51    0.010491         201        52        48 openat</span><br><span class="line"> 24.14    0.007557         157        48        47 stat64</span><br><span class="line"> 14.51    0.004544         378        12           lstat64</span><br><span class="line">  5.88    0.001842         921         2           getdents64</span><br><span class="line">  5.58    0.001748         194         9           mmap2</span><br><span class="line">  4.45    0.001393         154         9           <span class="built_in">read</span></span><br><span class="line">  3.58    0.001120         140         8           mprotect</span><br><span class="line">  2.33    0.000730         121         6           _llseek</span><br><span class="line">  1.87    0.000586         117         5           fstat64</span><br><span class="line">  1.59    0.000498         124         4           close</span><br><span class="line">  1.19    0.000373          93         4         3 ioctl</span><br><span class="line">  0.58    0.000181          60         3           brk</span><br><span class="line">  0.46    0.000144         144         1           set_tls</span><br><span class="line">  0.32    0.000099          99         1           write</span><br><span class="line">  0.00    0.000000           0         1           execve</span><br><span class="line">  0.00    0.000000           0         2         2 access</span><br><span class="line">  0.00    0.000000           0         1           gettimeofday</span><br><span class="line">  0.00    0.000000           0         1           uname</span><br><span class="line">  0.00    0.000000           0         1           getuid32</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line">100.00    0.031306                   170       100 total</span><br></pre></td></tr></table></figure>

<p>åˆæˆ–è€…æµ‹è¯•ä¸€ä¸‹memeé©±åŠ¨æ¨¡å—</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># strace echo 123 &gt; /dev/meme</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="comment">#æœ€åå‡ è¡Œ</span></span><br><span class="line">close(3)                                = 0</span><br><span class="line">set_tls(0x76fbe4f0)                     = 0</span><br><span class="line">mprotect(0x76ef0000, 8192, PROT_READ)   = 0</span><br><span class="line">mprotect(0x76f12000, 4096, PROT_READ)   = 0</span><br><span class="line">mprotect(0x76f95000, 4096, PROT_READ)   = 0</span><br><span class="line">mprotect(0x533000, 12288, PROT_READ)    = 0</span><br><span class="line">mprotect(0x76fbf000, 4096, PROT_READ)   = 0</span><br><span class="line">getuid32()                              = 0</span><br><span class="line">brk(NULL)                               = 0x537000</span><br><span class="line">brk(0x558000)                           = 0x558000</span><br><span class="line">write(1, <span class="string">&quot;123\n&quot;</span>, 4)                    = 4</span><br><span class="line">exit_group(0)                           = ?</span><br><span class="line">+++ exited with 0 +++</span><br></pre></td></tr></table></figure>

<p>æ€»ä¹‹<code>strace</code>æ˜¯ä¸€ä¸ªéå¸¸ç‰›é€¼çš„è¯Šæ–­å·¥å…·ï¼Œç”±äºæœ¬æ–‡ä¸»è¦é’ˆå¯¹çš„æ˜¯Linuxé©±åŠ¨æ¨¡å—æŠ€æœ¯ï¼Œå…³äºè¿™ä¸ªå‘½ä»¤çš„ä½¿ç”¨è¯¦è§£å°±ä¸èµ˜è¿°äº†ï¼Œè‡ªè¡ŒGoogleã€‚</p>
<h2 id="oopsæ¶ˆæ¯"><a href="#oopsæ¶ˆæ¯" class="headerlink" title="oopsæ¶ˆæ¯"></a>oopsæ¶ˆæ¯</h2><p>oopsä¹Ÿå°±æ˜¯å†…æ ¸ç”©äº†ä¸€è·¤æ‰€å‘å‡ºçš„æƒ¨å«ï¼Œå½“ç„¶å¯¼è‡´å†…æ ¸æ‘”è·¤çš„ç»Šè„šçŸ³å¤§æ¦‚ç‡æ˜¯æˆ‘ä»¬å†™å‡ºäº†è´¨é‡åº•ä¸‹çš„é©±åŠ¨æ¨¡å—å¯¼è‡´ã€‚ä¸¾ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __init <span class="title">meme_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *(<span class="keyword">int</span>*)<span class="literal">NULL</span> = <span class="number">123</span>;</span><br><span class="line">&#125;</span><br><span class="line">module_init(meme_init)</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šæ˜¯memeæ¨¡å—åŠ è½½æ—¶çš„åˆå§‹åŒ–ä»£ç ï¼Œä½†æ˜¯æˆ‘ä»¬è¯•å›¾å¾€<code>NULL</code>åœ°å€é‡Œèµ‹å€¼ï¼Œå¾ˆæ˜¾ç„¶è¿™å°†å¼•å‘æ®µé”™è¯¯ï¼Œå¦‚æœç›´æ¥insmodæ¨¡å—ï¼Œä¸å‡ºæ„å¤–å†…æ ¸å°†å‘å‡ºä¸€å£°æƒ¨å«â€”â€”oops!!!</p>
<p>æ¥çœ‹çœ‹æ•ˆæœï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># insmod meme.ko</span></span><br><span class="line"></span><br><span class="line">meme: loading out-of-tree module taints kernel.</span><br><span class="line">Unable to handle kernel NULL pointer dereference at virtual address 00000000</span><br><span class="line">pgd = 7dfd5e30</span><br><span class="line">[00000000] *pgd=00000000</span><br><span class="line">Internal error: Oops: 805 [<span class="comment">#1] SMP ARM</span></span><br><span class="line">Modules linked <span class="keyword">in</span>: meme(O+)</span><br><span class="line">CPU: 0 PID: 832 Comm: insmod Tainted: G           O      5.0.7 <span class="comment">#1</span></span><br><span class="line">Hardware name: ARM-Versatile Express</span><br><span class="line">PC is at meme_init+0x18/0x94 [meme]</span><br><span class="line">LR is at do_one_initcall+0x54/0x1fc</span><br><span class="line">pc : [&lt;7f005018&gt;]    lr : [&lt;80102e70&gt;]    psr: 600f0013</span><br><span class="line">sp : 9ddfbdc0  ip : 9dce1540  fp : 80b08c08</span><br><span class="line">r10: 00000000  r9 : 7f002040  r8 : 7f005000</span><br><span class="line">r7 : 00000000  r6 : ffffe000  r5 : 7f002240  r4 : 00000000</span><br><span class="line">r3 : 0000007b  r2 : 7ed12b89  r1 : 00000000  r0 : 00000000</span><br><span class="line">Flags: nZCv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment none</span><br><span class="line">Control: 10c5387d  Table: 7de00059  DAC: 00000051</span><br><span class="line">Process insmod (pid: 832, stack <span class="built_in">limit</span> = 0x560ea799)</span><br><span class="line">Stack: (0x9ddfbdc0 to 0x9ddfc000)</span><br><span class="line">bdc0: 80b08c08 80b603c0 ffffe000 80102e70 00000000 80136cc8 006000c0 00000000</span><br><span class="line">bde0: 00000000 9ddfbde4 9ddfbde4 7ed12b89 7f002088 a9245000 a9244fff fffff000</span><br><span class="line">be00: 00000000 9dce1700 9dce1700 80b76b90 00000001 9dce1a24 7f002040 7ed12b89</span><br><span class="line">be20: 7f002040 00000001 9dce1a00 9dce14c0 9dce1a24 801a03b8 9dce1a24 80232fc0</span><br><span class="line">be40: 9ddfbf30 9ddfbf30 00000001 9dce1a00 00000001 8019f5c0 7f00204c 00007fff</span><br><span class="line">be60: 7f002040 8019ca04 00000001 7f002088 8019c364 7f002154 7f002170 8094b580</span><br><span class="line">be80: 7f00222c 7f006000 808e1fd8 808e1fe4 808e203c 80b08c08 9dce7600 fffff000</span><br><span class="line">bea0: 80b0b5c4 006002c0 9dce7600 00000043 00000000 00000000 00000000 00000000</span><br><span class="line">bec0: 00000000 00000000 6e72656b 00006c65 00000000 00000000 00000000 00000000</span><br><span class="line">bee0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">bf00: 00000000 7ed12b89 00000080 00002a94 76d4da9c a9243a94 ffffe000 80b08c08</span><br><span class="line">bf20: 004cb9a7 00000000 00000051 8019fbf8 a92018d2 a9201a40 a9201000 00042a94</span><br><span class="line">bf40: a9243314 a924313c a9234104 00003000 00003180 00000000 00000000 00000000</span><br><span class="line">bf60: 00001d50 0000002d 0000002e 00000014 00000000 00000010 00000000 7ed12b89</span><br><span class="line">bf80: 9e61a600 76ee7404 00042a94 76f0ddc0 00000080 80101204 9ddfa000 00000080</span><br><span class="line">bfa0: 004b78e3 80101000 76ee7404 00042a94 76d0b008 00042a94 004cb9a7 76f0f968</span><br><span class="line">bfc0: 76ee7404 00042a94 76f0ddc0 00000080 00000001 7ec25eac 004cb9a7 004b78e3</span><br><span class="line">bfe0: 7ec25b68 7ec25b58 0042b291 76de3f12 200f0030 76d0b008 00000000 00000000</span><br><span class="line">[&lt;7f005018&gt;] (meme_init [meme]) from [&lt;80102e70&gt;] (do_one_initcall+0x54/0x1fc)</span><br><span class="line">[&lt;80102e70&gt;] (do_one_initcall) from [&lt;801a03b8&gt;] (do_init_module+0x64/0x1f4)</span><br><span class="line">[&lt;801a03b8&gt;] (do_init_module) from [&lt;8019f5c0&gt;] (load_module+0x1ed4/0x23b4)</span><br><span class="line">[&lt;8019f5c0&gt;] (load_module) from [&lt;8019fbf8&gt;] (sys_init_module+0x158/0x18c)</span><br><span class="line">[&lt;8019fbf8&gt;] (sys_init_module) from [&lt;80101000&gt;] (ret_fast_syscall+0x0/0x54)</span><br><span class="line">Exception stack(0x9ddfbfa8 to 0x9ddfbff0)</span><br><span class="line">bfa0:                   76ee7404 00042a94 76d0b008 00042a94 004cb9a7 76f0f968</span><br><span class="line">bfc0: 76ee7404 00042a94 76f0ddc0 00000080 00000001 7ec25eac 004cb9a7 004b78e3</span><br><span class="line">bfe0: 7ec25b68 7ec25b58 0042b291 76de3f12</span><br><span class="line">Code: e3475f00 e3a04000 e3a0307b e1a01004 (e5843000) </span><br><span class="line">---[ end trace c5673f359b9dfbf8 ]---</span><br><span class="line">Segmentation fault</span><br></pre></td></tr></table></figure>

<p>å¤šä¹ˆç†Ÿæ‚‰çš„å‘³é“ï¼Œä¿¡æ¯é‡å¥½å¤§ï¼Œè®©äººçœ¼èŠ±ç¼­ä¹±ã€‚åˆ«ç€æ€¥ï¼Œä¸»è¦ç•™æ„å‡ ä¸ªåœ°æ–¹ï¼š</p>
<ol>
<li><code>Modules linked in: meme(O+)</code>è¯´æ˜å¯¼è‡´oopsçš„æ˜¯memeæ¨¡å—é©±åŠ¨ã€‚</li>
<li><code>PC is at meme_init+0x18/0x94 [meme]</code>è¯´æ˜å¼•å‘oopsçš„å‡½æ•°æ˜¯<code>meme_init</code>ã€‚</li>
<li><code>Exception stack(0x9ddfbfa8 to 0x9ddfbff0)</code>ä»¥åŠä¹‹åçš„Nä¸ªåœ°å€è¡¨ç¤ºå¼‚å¸¸çš„æ ˆåŒºï¼Œè¯»æ‡‚è¿™äº›åœ°å€éœ€è¦æ¯”è¾ƒä¸°å¯Œçš„ç»éªŒï¼Œåˆšå¼€å§‹æ²¡å¿…è¦å¤ªçº ç»“è¿™éƒ¨åˆ†ã€‚</li>
<li><code>Segmentation fault</code>è¡¨ç¤ºé”™è¯¯ç±»å‹æ˜¯æ®µé”™è¯¯</li>
</ol>
<h2 id="ä½¿ç”¨gdbã€kgdbç­‰è°ƒè¯•å™¨"><a href="#ä½¿ç”¨gdbã€kgdbç­‰è°ƒè¯•å™¨" class="headerlink" title="ä½¿ç”¨gdbã€kgdbç­‰è°ƒè¯•å™¨"></a>ä½¿ç”¨gdbã€kgdbç­‰è°ƒè¯•å™¨</h2><p>å…³äºgdbè°ƒè¯•ç¥å™¨å¦‚ä½•åº”ç”¨åˆ°å†…æ ¸æ¨¡å—ï¼Œå°±ä¸è¯¦è¿°äº†ï¼Œå¦‚æœçœŸæƒ³äº†è§£å¯ä»¥å‚è€ƒIBMè¿™ç¯‡<a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/linux/l-kdb/index.html">ã€ŠLinuxç³»ç»Ÿå†…æ ¸çš„è°ƒè¯•ã€‹</a>ã€‚</p>
<p>å…¶å®gdbå¯ä»¥æä¾›è¯¸å¦‚æ–­ç‚¹ã€å˜é‡ç›‘è§†ã€å•æ­¥æ‰§è¡Œç­‰éå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œåœ¨è¿½è¸ªbugçš„æ•ˆç‡æ–¹é¢æ— ç–‘å¯ä»¥ç¢¾å‹ä¸Šè¿°çš„å‡ ç§æ–¹å¼ã€‚ä½†æ˜¯å¯åˆ«å¿˜äº†ï¼Œæˆ‘ä»¬å†™çš„æ˜¯Linuxå†…æ ¸æ¨¡å—ï¼Œè¿™äº›æ–­ç‚¹ã€å•æ­¥æ‰§è¡Œçš„åŠŸèƒ½å…¶å®å¾ˆéš¾åº”ç”¨çš„å†…æ ¸å±‚ï¼Œè€Œä¸”é©±åŠ¨æœ¬è´¨ä¸Šæ˜¯ä¸ºç¡¬ä»¶æœåŠ¡çš„ï¼Œä½ è¦ä»£ç å•æ­¥æ‰§è¡Œå¯ä»¥ï¼Œç¡¬ä»¶é‚£è¾¹å¯æ²¡æœ‰æš‚åœé”®å•Šï¼</p>
<p>æ‰€ä»¥ï¼Œåœ¨Linuxé©±åŠ¨æ¨¡å—çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œgdbè¿™ç§å·¥å…·åè€Œåº”è¯¥å°½é‡é¿å…ï¼</p>
<h2 id="å°ç»“ä¸€ä¸‹"><a href="#å°ç»“ä¸€ä¸‹" class="headerlink" title="å°ç»“ä¸€ä¸‹"></a>å°ç»“ä¸€ä¸‹</h2><ul>
<li><code>printk()</code>æ˜¯æœ€æœ´å®æœ‰æ•ˆçš„è°ƒè¯•æ–¹å¼ï¼ŒLinuxä¸€å…±æä¾›äº†8ä¸ªæ‰“å°çº§åˆ«ï¼Œå¯ä»¥é€šè¿‡<code>echo N &gt; /proc/sys/kernel/printk</code>æ¥é™åˆ¶çº§åˆ«ã€‚</li>
<li>å¯ä»¥é€šè¿‡åˆ›å»º<code>/proc/&lt;entry&gt;</code>å…¥å£æ–‡ä»¶æ¥å‡å°‘å¯¹printkçš„ä¾èµ–</li>
<li><code>seq_file</code>æ˜¯procfså…¥å£æ–‡ä»¶çš„ç‰¹æ®Šå®ç°æ–¹å¼ï¼Œä¸»è¦ç”¨äºçŠ¶æ€ä¿¡æ¯åºå¤§çš„é©±åŠ¨ï¼ŒæŒ‰é¡ºåºè¿­ä»£è¾“å‡ºã€‚</li>
<li><code>strace</code>æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„ç¨‹åºæ‰§è¡Œè·Ÿè¸ªçš„å‘½ä»¤ã€‚</li>
<li><code>oops</code>æœ¬è´¨ä¸Šæ˜¯å†…æ ¸æŸäº›åœ°æ–¹æ‰§è¡Œå‡ºé”™äº§ç”Ÿçš„æç¤ºä¿¡æ¯ï¼Œå¯ä»¥ç”¨äºå®šä½é—®é¢˜æ ¹æºã€‚</li>
</ul>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>æœ¬æ–‡ä½œè€…ï¼š </strong>Philon
  </li>
  <li class="post-copyright-link">
    <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
    <a href="https://ixx.life/ArmLinuxDriver/chapter5/" title="äºŒï¼šè°ƒè¯•æŠ€æœ¯">https://ixx.life/ArmLinuxDriver/chapter5/</a>
  </li>
  <li class="post-copyright-license">
    <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ARM/" rel="tag"># ARM</a>
              <a href="/tags/Linux/" rel="tag"># Linux</a>
              <a href="/tags/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/" rel="tag"># é©±åŠ¨å¼€å‘</a>
              <a href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/" rel="tag"># åµŒå…¥å¼</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/97ThingsEveryProgrammerShouldKnow/37/" rel="prev" title="é«˜å¼ºåº¦å·¥ä½œä¸ä¼šå¾—åˆ°å›æŠ¥">
      <i class="fa fa-chevron-left"></i> é«˜å¼ºåº¦å·¥ä½œä¸ä¼šå¾—åˆ°å›æŠ¥
    </a></div>
      <div class="post-nav-item">
    <a href="/97ThingsEveryProgrammerShouldKnow/38/" rel="next" title="å¦‚ä½•ä½¿ç”¨Bugè·Ÿè¸ªå™¨">
      å¦‚ä½•ä½¿ç”¨Bugè·Ÿè¸ªå™¨ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Philon"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Philon</p>
  <div class="site-description" itemprop="description">ä¸€ä¸ªç¨‹åºå‘˜çš„æˆé•¿è¶³è¿¹</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">177</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">77</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/philon" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;philon" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ixx.life</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'Y5scg9Ix4iae04UOae0uJSJA-gzGzoHsz',
      appKey     : 'U9hHApgNVDExYRJqXvUs5ykr',
      placeholder: "è¯´ç‚¹ä»€ä¹ˆå§...",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
