<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo48x48.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo48x48.png">
  <link rel="mask-icon" href="/images/logo.png" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ixx.life","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="æˆ‘ä»¬å¯ä»¥é€šè¿‡goroutineå’Œchannelæœºåˆ¶éå¸¸æ–¹ä¾¿åœ°ç¼–å†™å¹¶å‘ä¸šåŠ¡ï¼Œä½†å°±å’Œé¢å‘å¯¹è±¡ä¸è®¾è®¡æ¨¡å¼çš„å…³ç³»ä¸€æ ·ï¼Œæ˜¯ä¸€ç§æ€æƒ³å…·ä½“è½å®åˆ°è¡ŒåŠ¨æ–¹é’ˆçš„è¿‡ç¨‹ï¼Œåœ¨ç‰›é€¼çš„æˆ˜ç•¥ï¼Œæ²¡æœ‰åŸºæœ¬çš„æˆ˜æœ¯æŒ‡å¯¼ï¼Œä¹Ÿåªæ˜¯ç©ºè°ˆã€‚ å› æ­¤ï¼Œç¬¬ä¸ƒç« å¹¶å‘æ¨¡å¼ï¼Œå¹¶æ²¡æœ‰å¤ªå¤šè¯­æ³•ä¸Šçš„æ–°ä¸œè¥¿ï¼Œè€Œæ˜¯åˆ©ç”¨goroutineå’Œchannelä»‹ç»äº†ä¸‰ç§å¹¶å‘æ¨¡å¼ï¼Œåˆ†åˆ«é€‚ç”¨äºä¸‰ç§ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ã€‚  runnerâ€”â€”ç»™æ¯ä¸ªå¹¶å‘ä»»åŠ¡è®¾ç½®deadlineï¼Œç®¡ç†å¹¶å‘ä»»">
<meta property="og:type" content="article">
<meta property="og:title" content="ä¸ƒï¼šå¹¶å‘æ¨¡å¼">
<meta property="og:url" content="https://ixx.life/GoInAction/chapter7/index.html">
<meta property="og:site_name" content="è‡ªå¢äººç”Ÿ">
<meta property="og:description" content="æˆ‘ä»¬å¯ä»¥é€šè¿‡goroutineå’Œchannelæœºåˆ¶éå¸¸æ–¹ä¾¿åœ°ç¼–å†™å¹¶å‘ä¸šåŠ¡ï¼Œä½†å°±å’Œé¢å‘å¯¹è±¡ä¸è®¾è®¡æ¨¡å¼çš„å…³ç³»ä¸€æ ·ï¼Œæ˜¯ä¸€ç§æ€æƒ³å…·ä½“è½å®åˆ°è¡ŒåŠ¨æ–¹é’ˆçš„è¿‡ç¨‹ï¼Œåœ¨ç‰›é€¼çš„æˆ˜ç•¥ï¼Œæ²¡æœ‰åŸºæœ¬çš„æˆ˜æœ¯æŒ‡å¯¼ï¼Œä¹Ÿåªæ˜¯ç©ºè°ˆã€‚ å› æ­¤ï¼Œç¬¬ä¸ƒç« å¹¶å‘æ¨¡å¼ï¼Œå¹¶æ²¡æœ‰å¤ªå¤šè¯­æ³•ä¸Šçš„æ–°ä¸œè¥¿ï¼Œè€Œæ˜¯åˆ©ç”¨goroutineå’Œchannelä»‹ç»äº†ä¸‰ç§å¹¶å‘æ¨¡å¼ï¼Œåˆ†åˆ«é€‚ç”¨äºä¸‰ç§ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ã€‚  runnerâ€”â€”ç»™æ¯ä¸ªå¹¶å‘ä»»åŠ¡è®¾ç½®deadlineï¼Œç®¡ç†å¹¶å‘ä»»">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-03-03T08:13:01.000Z">
<meta property="article:modified_time" content="2021-07-21T22:56:15.019Z">
<meta property="article:author" content="Philon">
<meta property="article:tag" content="GOè¯­è¨€">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://ixx.life/GoInAction/chapter7/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>ä¸ƒï¼šå¹¶å‘æ¨¡å¼ | è‡ªå¢äººç”Ÿ</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">è‡ªå¢äººç”Ÿ</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">ä½•ä»¥è§£å¿§ï¼Œå”¯æœ‰ i++</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-books">

    <a href="/books/" rel="section"><i class="fa  fa-book fa-fw"></i>è¯»ä¹¦å†™ä½œ</a>

  </li>
        <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-pen fa-fw"></i>å­¦ä¹ ç¬”è®°</a>

  </li>
        <li class="menu-item menu-item-leetcode">

    <a href="/leetcode/" rel="section"><i class="fa fa-fire fa-fw"></i>LeetCode</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ixx.life/GoInAction/chapter7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Philon">
      <meta itemprop="description" content="ä¸€ä¸ªç¨‹åºå‘˜çš„æˆé•¿è¶³è¿¹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è‡ªå¢äººç”Ÿ">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ä¸ƒï¼šå¹¶å‘æ¨¡å¼
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-03-03 16:13:01" itemprop="dateCreated datePublished" datetime="2019-03-03T16:13:01+08:00">2019-03-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E3%80%8AGO%E8%AF%AD%E8%A8%80%E5%AE%9E%E6%88%98%E3%80%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">ã€ŠGOè¯­è¨€å®æˆ˜ã€‹å­¦ä¹ ç¬”è®°</span></a>
                </span>
            </span>

          
            <span id="/GoInAction/chapter7/" class="post-meta-item leancloud_visitors" data-flag-title="ä¸ƒï¼šå¹¶å‘æ¨¡å¼" title="é˜…è¯»æ¬¡æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/GoInAction/chapter7/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/GoInAction/chapter7/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>æˆ‘ä»¬å¯ä»¥é€šè¿‡goroutineå’Œchannelæœºåˆ¶éå¸¸æ–¹ä¾¿åœ°ç¼–å†™å¹¶å‘ä¸šåŠ¡ï¼Œä½†å°±å’Œé¢å‘å¯¹è±¡ä¸è®¾è®¡æ¨¡å¼çš„å…³ç³»ä¸€æ ·ï¼Œæ˜¯ä¸€ç§æ€æƒ³å…·ä½“è½å®åˆ°è¡ŒåŠ¨æ–¹é’ˆçš„è¿‡ç¨‹ï¼Œåœ¨ç‰›é€¼çš„æˆ˜ç•¥ï¼Œæ²¡æœ‰åŸºæœ¬çš„æˆ˜æœ¯æŒ‡å¯¼ï¼Œä¹Ÿåªæ˜¯ç©ºè°ˆã€‚</p>
<p>å› æ­¤ï¼Œç¬¬ä¸ƒç« å¹¶å‘æ¨¡å¼ï¼Œå¹¶æ²¡æœ‰å¤ªå¤šè¯­æ³•ä¸Šçš„æ–°ä¸œè¥¿ï¼Œè€Œæ˜¯åˆ©ç”¨goroutineå’Œchannelä»‹ç»äº†ä¸‰ç§å¹¶å‘æ¨¡å¼ï¼Œåˆ†åˆ«é€‚ç”¨äºä¸‰ç§ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ã€‚</p>
<ol>
<li>runnerâ€”â€”ç»™æ¯ä¸ªå¹¶å‘ä»»åŠ¡è®¾ç½®deadlineï¼Œç®¡ç†å¹¶å‘ä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸ</li>
<li>poolâ€”â€”åˆ©ç”¨æœ‰ç¼“å†²é€šé“åˆ›å»ºèµ„æºæ± ï¼Œç»Ÿä¸€ç®¡ç†å¹¶å‘æ—¶çš„èµ„æºè®¿é—®</li>
<li>workâ€”â€”åˆ©ç”¨æ— ç¼“å†²é€šé“åˆ›å»ºgoroutineæ± ï¼Œç»Ÿä¸€ç®¡ç†å¹¶å‘</li>
</ol>
<h2 id="runner"><a href="#runner" class="headerlink" title="runner"></a>runner</h2><p>å…ˆå‡è®¾ä¸€ä¸ªåœºæ™¯éœ€æ±‚ï¼Œæ¯”å¦‚httpæœåŠ¡çš„å¹¶å‘ï¼Œæˆ‘ä»¬è¦ä¸ºæ¯ä¸ªæ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„å¹¶å‘å“åº”ä»»åŠ¡ï¼Œä½†è¿™ä¸ªæœ€å¥½åœ¨æŸä¸ªè§„å®šçš„æ—¶é—´å†…å®Œæˆå“åº”ï¼Œå¦åˆ™å°±å¼ºåˆ¶å®ƒé€€å‡ºï¼Œè¿™æ ·å¯ä»¥å¾ˆå¥½åœ°é¿å…æŸäº›æƒ…å†µä¸‹ï¼Œä¸€äº›å¹¶å‘ä»»åŠ¡å¡æ­»çš„æƒ…å†µï¼ŒåŒæ—¶å¯ä»¥å¾ˆå¥½åœ°ç®¡ç†æ¯ä¸ªå¹¶å‘çš„ç”Ÿå‘½å‘¨æœŸã€‚  </p>
<p>runnerå°±æ˜¯ä¸ºè¿™æ ·çš„åœºæ™¯åº”ç”¨è€Œç”Ÿçš„ï¼Œrunnerå¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ªè¿è¡Œç®¡ç†å™¨ï¼Œæ‰€æœ‰çš„å¹¶å‘ä»»åŠ¡éƒ½è¦å«ç»™å®ƒè´Ÿè´£ç®¡ç†ï¼Œå®ƒè´Ÿè´£å¹¶å‘ä»»åŠ¡çš„å¯åŠ¨ã€è¶…æ—¶ç›‘æ§ã€å¼ºåˆ¶ä¸­æ–­ç­‰ã€‚</p>
<p>(ç”±äºæˆ‘ä¸ªäººåœ¨é˜…è¯»åŸè‘—çš„æ—¶å€™æ˜¯å…ˆè®²runnerçš„å†…éƒ¨å®ç°ï¼Œå†çœ‹å®é™…åº”ç”¨ï¼Œæ€»æ„Ÿè§‰äº‘é‡Œé›¾é‡Œçš„ï¼Œè§‰å¾—è¿˜æ˜¯å…ˆé€šç¯‡çœ‹ä¸€ä¸‹å¦‚ä½•è¿ç”¨runnerï¼Œå†æ¥çœ‹å…¶å†…éƒ¨çš„å®ç°ï¼Œå¯èƒ½æ•ˆæœä¼šå¥½ä¸€ç‚¹)</p>
<p>å…ˆæ¥çœ‹runnerçš„ç¤ºä¾‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">testRunner</span><span class="params">()</span></span> &#123;</span><br><span class="line">  log.Println(<span class="string">&quot;Runner test starting work...&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–°å»ºä¸€ä¸ªrunnerï¼Œå¹¶å¼ºåˆ¶æ¯ä¸ªå¹¶å‘ä»»åŠ¡çš„è¶…æ—¶æ—¶é—´ä¸º5ç§’</span></span><br><span class="line">  r := runner.New(<span class="number">3</span> * time.Second)</span><br><span class="line">  <span class="comment">// å¾ªç¯åˆ›å»º10ä¸ªå¹¶å‘ä»»åŠ¡ï¼Œå¹¶å°†å…¶ä¸¢ç»™runnerç®¡ç†</span></span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">    r.Add(<span class="function"><span class="keyword">func</span><span class="params">(id <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">      <span class="comment">// è¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿï¼Œæ¯ä¸ªå¹¶å‘ä»»åŠ¡éƒ½æ˜¯ç¡çœ å®ƒè‡ªèº«idçš„ç§’æ•°</span></span><br><span class="line">      log.Printf(<span class="string">&quot;Processor - Task #%d.\n&quot;</span>, id)</span><br><span class="line">      time.Sleep(time.Duration(id) * time.Second)</span><br><span class="line">      log.Printf(<span class="string">&quot;Task #%d done.\n&quot;</span>, id)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸€æ¬¡æ€§å¯åŠ¨runnerå†…éƒ¨çš„å…¨éƒ¨å¹¶å‘ä»»åŠ¡</span></span><br><span class="line">  <span class="keyword">if</span> err := r.Start(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> err &#123;</span><br><span class="line">    <span class="keyword">case</span> runner.ErrTimeout:</span><br><span class="line">      <span class="comment">// å½“å¹¶å‘ä»»åŠ¡ä¸­æœ‰ä»»åŠ¡æ‰§è¡Œè¶…æ—¶ï¼Œå°±ç«‹å³è¿”å›</span></span><br><span class="line">      log.Println(<span class="string">&quot;Terminating due to timeout.&quot;</span>)</span><br><span class="line">      os.Exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">case</span> runner.ErrInterrupt:</span><br><span class="line">      <span class="comment">// å½“ç¨‹åºè¢«ctrl+cæ—¶ï¼Œå¼ºåˆ¶ç»“æŸæ‰€æœ‰å¹¶å‘ä»»åŠ¡</span></span><br><span class="line">      log.Println(<span class="string">&quot;Terminating due to interrupt.&quot;</span>)</span><br><span class="line">      os.Exit(<span class="number">2</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  log.Println(<span class="string">&quot;Process end.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-------------ç¨‹åºè¾“å‡º---------------</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">03</span>/<span class="number">03</span> <span class="number">14</span>:<span class="number">48</span>:<span class="number">41</span> Runner test starting work...</span><br><span class="line"><span class="number">2019</span>/<span class="number">03</span>/<span class="number">03</span> <span class="number">14</span>:<span class="number">48</span>:<span class="number">41</span> Processor - Task #<span class="number">2.</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">03</span>/<span class="number">03</span> <span class="number">14</span>:<span class="number">48</span>:<span class="number">41</span> Processor - Task #<span class="number">4.</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">03</span>/<span class="number">03</span> <span class="number">14</span>:<span class="number">48</span>:<span class="number">41</span> Processor - Task #<span class="number">3.</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">03</span>/<span class="number">03</span> <span class="number">14</span>:<span class="number">48</span>:<span class="number">41</span> Processor - Task #<span class="number">0.</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">03</span>/<span class="number">03</span> <span class="number">14</span>:<span class="number">48</span>:<span class="number">41</span> Task #<span class="number">0</span> done.</span><br><span class="line"><span class="number">2019</span>/<span class="number">03</span>/<span class="number">03</span> <span class="number">14</span>:<span class="number">48</span>:<span class="number">41</span> Processor - Task #<span class="number">1.</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">03</span>/<span class="number">03</span> <span class="number">14</span>:<span class="number">48</span>:<span class="number">42</span> Task #<span class="number">1</span> done.</span><br><span class="line"><span class="number">2019</span>/<span class="number">03</span>/<span class="number">03</span> <span class="number">14</span>:<span class="number">48</span>:<span class="number">43</span> Task #<span class="number">2</span> done.</span><br><span class="line"><span class="comment">// ----ç¬¬3ä¸ªåŠä»¥åçš„ä»»åŠ¡å› ä¸ºè¦ç¡3ç§’ä»¥ä¸Šï¼Œè‚¯å®šä¼šè¶…æ—¶----</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">03</span>/<span class="number">03</span> <span class="number">14</span>:<span class="number">48</span>:<span class="number">44</span> Terminating due to timeout.</span><br><span class="line"><span class="comment">// ----å¦‚ä½•è¿è¡Œè¿‡ç¨‹ä¸­æŒ‰ctrl+cï¼Œä¼šå®‰å…¨é€€å‡ºå¹¶æç¤º----</span></span><br><span class="line">^C2019/<span class="number">03</span>/<span class="number">03</span> <span class="number">14</span>:<span class="number">49</span>:<span class="number">36</span> Terminating due to interrupt.</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œrunnerå°±æ˜¯ä¸€ä¸ªç±»å‹ï¼Œéœ€è¦ç”¨å…¶åˆ›å»ºå¯¹è±¡åæ‰èƒ½å…·ä½“ä½¿ç”¨ã€‚è€Œåœ¨å¤–éƒ¨ï¼Œæˆ‘ä»¬åªéœ€è¦å®šä¹‰å¥½æ¯ä¸ªä»»åŠ¡çš„å‡½æ•°ï¼Œå¹¶ç®€å•çš„å°†å®ƒä»¬æ·»åŠ åˆ°runnerå½“ä¸­å³å¯ï¼Œå‰©ä¸‹çš„å…¨éƒ¨äº¤ç”±runnerè‡ªè¡Œç®¡ç†ã€‚</p>
<p>ç°åœ¨å†æ¥çœ‹çœ‹runnerç±»å‹æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runner åœ¨æŒ‡å®šçš„è¶…æ—¶æ—¶é—´å†…å®Œæˆä¸€ç»„ä»»åŠ¡</span></span><br><span class="line"><span class="comment">// å¹¶ä¸”åœ¨è¿™ä¸ªæ—¶é—´å‘¨æœŸå†…æ¥æ”¶ç³»ç»Ÿçš„ä¸­æ–­ä¿¡å·æ¥ç»“æŸè¿™ç»„ä»»åŠ¡</span></span><br><span class="line"><span class="keyword">type</span> Runner <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="comment">// ä»ç³»ç»Ÿæ¥æ”¶ä¸­æ–­ä¿¡å·çš„é€šé“</span></span><br><span class="line">  interrupt <span class="keyword">chan</span> os.Signal</span><br><span class="line">  <span class="comment">// ä»»åŠ¡å·²å®Œæˆçš„æŠ¥å‘Šé€šé“</span></span><br><span class="line">  complete <span class="keyword">chan</span> error</span><br><span class="line">  <span class="comment">// ä»»åŠ¡è¶…æ—¶çš„æŠ¥å‘Šé€šé“</span></span><br><span class="line">  timeout &lt;-<span class="keyword">chan</span> time.Time</span><br><span class="line">  <span class="comment">// ä»»åŠ¡åˆ—è¡¨</span></span><br><span class="line">  tasks []<span class="function"><span class="keyword">func</span><span class="params">(id <span class="keyword">int</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ErrTimeout ä»»åŠ¡æ‰§è¡Œè¶…æ—¶æ—¶è¿”å›</span></span><br><span class="line"><span class="keyword">var</span> ErrTimeout = errors.New(<span class="string">&quot;received timeout&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ErrInterrupt æ”¶åˆ°ç³»ç»Ÿä¸­æ–­ä¿¡å·æ—¶è¿”å›</span></span><br><span class="line"><span class="keyword">var</span> ErrInterrupt = errors.New(<span class="string">&quot;received interrupt&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// New åˆ›å»ºRunnerçš„å·¥å‚å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(d time.Duration)</span> *<span class="title">Runner</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &amp;Runner&#123;</span><br><span class="line">    interrupt: <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>),</span><br><span class="line">    complete:  <span class="built_in">make</span>(<span class="keyword">chan</span> error),</span><br><span class="line">    timeout:   time.After(d),</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add Runnerçš„æ–¹æ³•ï¼Œå°†å¤šä¸ªä»»åŠ¡æ·»åŠ åˆ°Runnerçš„ä»»åŠ¡åˆ—è¡¨ä¸­</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Runner)</span> <span class="title">Add</span><span class="params">(tasks ...<span class="keyword">func</span>(<span class="keyword">int</span>)</span>)</span> &#123;</span><br><span class="line">  r.tasks = <span class="built_in">append</span>(r.tasks, tasks...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Start Runnerçš„æ–¹æ³•ï¼Œå¯åŠ¨æ‰€æœ‰ä»»åŠ¡ï¼Œå¹¶ç›‘å¬é€šé“äº‹ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Runner)</span> <span class="title">Start</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  <span class="comment">// å¼€å§‹æ¥æ”¶ç³»ç»Ÿçš„ä¸­æ–­é€šçŸ¥</span></span><br><span class="line">  signal.Notify(r.interrupt, os.Interrupt)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é€šè¿‡goroutingå¹¶è¡Œå¯åŠ¨æ‰€æœ‰ä»»åŠ¡åˆ—è¡¨ä¸­çš„ä»»åŠ¡</span></span><br><span class="line">  <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">  wg.Add(<span class="built_in">len</span>(r.tasks))</span><br><span class="line">  <span class="keyword">for</span> i, t := <span class="keyword">range</span> r.tasks &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(id <span class="keyword">int</span>, task <span class="keyword">func</span>(<span class="keyword">int</span>)</span>)</span> &#123;</span><br><span class="line">      task(id)</span><br><span class="line">      wg.Done()</span><br><span class="line">    &#125;(i, t)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå¹¶ç»™â€œå·²å®Œæˆé€šé“â€ä¸€ä¸ªæŠ¥å‘Š</span></span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    wg.Wait()</span><br><span class="line">    r.complete &lt;- <span class="literal">nil</span></span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–æ— ç¼“å†²é€šé“æ•°æ®æ—¶ï¼Œå¦‚æœæ²¡å‡†å¤‡å¥½ï¼Œä¼šè¢«é˜»å¡</span></span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> err := &lt;-r.complete: <span class="comment">// ä»»åŠ¡æ­£å¸¸å®è¡Œå®Œè¿”å›ä»»åŠ¡è‡ªèº«çš„â€œé”™è¯¯æ ‡ç¤ºâ€</span></span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  <span class="keyword">case</span> &lt;-r.timeout: <span class="comment">// ä»»åŠ¡æ‰§è¡Œè¶…æ—¶ï¼Œè¿”å›è¶…æ—¶é”™è¯¯</span></span><br><span class="line">    <span class="keyword">return</span> ErrTimeout</span><br><span class="line">  <span class="keyword">case</span> &lt;-r.interrupt: <span class="comment">// å¦‚æœæ”¶åˆ°ctrl+Cåˆ™åœæ­¢æ¥æ”¶åç»­çš„ä¿¡å·</span></span><br><span class="line">    signal.Stop(r.interrupt)</span><br><span class="line">    <span class="keyword">return</span> ErrInterrupt</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äºåªæ˜¯åŸå‹æ¼”ç¤ºï¼Œrunnerçš„å†…éƒ¨å®ç°ä¸ç®—å¤æ‚ï¼Œåªéœ€è¦è®°ä½ä¸€ä¸ªæ ¸å¿ƒæ€æƒ³<strong>æ— ç¼“å†²é€šé“åœ¨æ²¡æœ‰æ•°æ®è¯»å†™çš„æ—¶å€™ï¼Œä¼šè¢«é˜»å¡</strong>ã€‚è¯´åƒé“ä¸‡ï¼Œrunnerå°±æ˜¯åˆ©ç”¨äº†è¿™ä¸ªç‰¹æ€§æ‰å¾—ä»¥åœ¨selectè¯­å¥ä¸­å®Œæˆäº†ï¼š</p>
<ul>
<li>å¹¶è¡Œæ¥æ”¶ç³»ç»Ÿçš„ä¸­æ–­ä¿¡å·â€”â€”interrupté€šé“ã€‚</li>
<li>å¹¶è¡Œæ¥æ”¶å®šæ—¶å™¨çš„è¶…æ—¶ä¿¡å·â€”â€”timeouté€šé“ã€‚</li>
</ul>
<h2 id="pool"><a href="#pool" class="headerlink" title="pool"></a>pool</h2><p>è¿™é‡Œçš„poolæ˜¯æŒ‡èµ„æºæ± çš„æ„æ€ï¼Œå¦‚æœç†Ÿæ‚‰Java/C#ä¸­çš„â€œæ•°æ®è¿æ¥æ± â€çš„æ¦‚å¿µï¼Œé‚£è¿™é‡Œçš„æ± å¤§ä½“å°±æ˜¯è¿™ä¸ªæ„æ€äº†ã€‚</p>
<p>æ¢è€Œè¨€ä¹‹ï¼Œåœ¨å¹¶å‘åœºæ™¯ä¸‹ï¼Œéš¾å…ä¼šé‡åˆ°å¹¶å‘ä»»åŠ¡äº‰å¤ºä¸´ç•Œèµ„æºçš„æƒ…å†µï¼Œè¿˜æ˜¯ä»¥æ•°æ®åº“è®¿é—®ä¸ºä¾‹ï¼šå¦‚æœæœ‰1000ä¸ªå¹¶å‘ä»»åŠ¡è¦å»è®¿é—®æ•°æ®åº“ï¼Œæ¯ä¸ªå¹¶å‘éƒ½éœ€è¦å®Œæˆå»ºç«‹è¿æ¥â€”â€”è®¤è¯â€”â€”æŸ¥è¯¢â€”â€”æ–­å¼€è¿æ¥ç­‰æ“ä½œï¼Œé‚£ä¸è®ºæ˜¯åº”ç”¨æœåŠ¡å™¨è¿˜æ˜¯æ•°æ®åº“æœåŠ¡å™¨ï¼Œæ— ç–‘éƒ½æ˜¯å·¨å¤§çš„è´Ÿæ‹…ã€‚å› æ­¤ï¼Œé€šè¿‡åˆ›å»º10ä¸ªæ•°æ®åº“è¿æ¥ï¼Œå¹¶æŠŠè¿™äº›â€œè¿æ¥â€å½“ä½œèµ„æºæ”¾å…¥â€œæ± â€ä¸­ï¼Œç»™æ‰€æœ‰çš„å¹¶å‘ä»»åŠ¡å…±äº«ï¼Œæ¯ä¸ªå¹¶å‘åœ¨éœ€è¦çš„æ—¶å€™ä»æ± ä¸­å–å‡ºè¿æ¥ï¼Œå®ŒæˆæŸ¥è¯¢åå†æ”¾å›æ± ä¸­ï¼Œä¸ä»…èƒ½å¤§å¹…é™ä½CPUçš„è´Ÿè½½ï¼Œä¹Ÿèƒ½å‡å°‘å†…å­˜çš„å¼€é”€ã€‚(ä½†æˆ‘ä¸ªäººè§‰å¾—æœ€çˆ½çš„åœ°æ–¹æ˜¯ï¼Œä½ çš„ä»£ç å¯ä»¥æ›´ä¸“æ³¨åœ°å»queryï¼Œè€Œä¸å¿…è€ƒè™‘connectionæœ¬èº«ğŸ˜‚)</p>
<p>åŒæ ·ï¼Œå…ˆæ¥çœ‹çœ‹poolçš„è¿ç”¨è¿‡ç¨‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">  maxGoroutines  = <span class="number">25</span> <span class="comment">// è¦ä½¿ç”¨çš„goroutineçš„æ•°é‡</span></span><br><span class="line">  pooledResource = <span class="number">5</span>  <span class="comment">// æ± ä¸­çš„èµ„æºçš„æ•°é‡</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// dbConnection æ¨¡æ‹Ÿè¦å…±äº«çš„èµ„æº</span></span><br><span class="line"><span class="keyword">type</span> dbConnection <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID <span class="keyword">int32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Close å®ç°io.Closer.Closeæ¥å£ï¼Œé‡Šæ”¾èµ„æº</span></span><br><span class="line"><span class="comment">// è®©å…¶å¯ä»¥è¢«Poolç®¡ç†</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dbConn *dbConnection)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  log.Println(<span class="string">&quot;Close: Connection&quot;</span>, dbConn.ID)</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// idCounter ç”¨æ¥ç»™æ¯ä¸ªè¿æ¥åˆ†é…å”¯ä¸€id</span></span><br><span class="line"><span class="keyword">var</span> idCounter <span class="keyword">int32</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// createConnection åˆ›å»ºå”¯ä¸€idçš„è¿æ¥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createConnection</span><span class="params">()</span> <span class="params">(io.Closer, error)</span></span> &#123;</span><br><span class="line">  id := atomic.AddInt32(&amp;idCounter, <span class="number">1</span>)</span><br><span class="line">  log.Println(<span class="string">&quot;Create: New Connection&quot;</span>, id)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &amp;dbConnection&#123;id&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// testPool Poolæµ‹è¯•ç”¨ä¾‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">testPool</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">  wg.Add(maxGoroutines)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºç®¡ç†è¿æ¥æ± ï¼Œå¹¶åˆ›å»ºNä¸ªâ€œè¿æ¥â€èµ„æºï¼ŒåŠ å…¥æ± ä¸­</span></span><br><span class="line">  p, err := pool.New(createConnection, pooledResource)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Println(err)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºMä¸ªå¹¶å‘ä»»åŠ¡ï¼Œæ¨¡æ‹ŸæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">  <span class="keyword">for</span> query := <span class="number">0</span>; query &lt; maxGoroutines; query++ &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(q <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">      performQueries(q, p)</span><br><span class="line">      wg.Done()</span><br><span class="line">    &#125;(query)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  wg.Wait()</span><br><span class="line">  log.Println(<span class="string">&quot;Shutdown Program&quot;</span>)</span><br><span class="line">  p.Close() <span class="comment">// å…³é—­æ± </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">performQueries</span><span class="params">(query <span class="keyword">int</span>, p *pool.Pool)</span></span> &#123;</span><br><span class="line">  conn, err := p.Acquire()</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Println(err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å®ŒæˆæŸ¥è¯¢åï¼Œå°†èµ„æºé‡Šæ”¾ä¼šæ± é‡Œ</span></span><br><span class="line">  <span class="keyword">defer</span> p.Release(conn)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”¨éšæœºç¡çœ 1000å¾®å¦™å†…çš„æ—¶é•¿ï¼Œæ¥æ¨¡æ‹ŸæŸ¥è¯¢ä¸­çš„è€—æ—¶</span></span><br><span class="line">  time.Sleep(time.Duration(rand.Intn(<span class="number">1000</span>)) * time.Millisecond)</span><br><span class="line">  log.Printf(<span class="string">&quot;QID[%d] CID[%d]\n&quot;</span>, query, conn.(*dbConnection).ID)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(å¯èƒ½æ˜¯æˆ‘æ²¡å­¦ä¹ åˆ°ä½ï¼Œæˆ‘ä¸ªäººè§‰å¾—poolæ¨¡å¼å¹¶ä¸æ˜¯ç‰¹åˆ«å®¹æ˜“æŒæ¡ï¼Œæ€æƒ³æ˜¯å¾ˆå¥½ç†è§£çš„ï¼Œä½†ç‰µæ‰¯å¤ªå¤šæ¥å£å®ç°ã€æœ‰/æ— ç¼“å†²é€šé“çš„ç‰¹æ€§ç­‰å†…å®¹ï¼Œæ‰€ä»¥ä»£ç å¯èƒ½è¦å†å¤šæ¶ˆåŒ–å‡ éã€‚)</p>
<p>å†çœ‹çœ‹poolåŒ…çš„å®ç°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Pool èµ„æºæ± </span></span><br><span class="line"><span class="comment">// ç®¡ç†ä¸€ç»„èµ„æºï¼Œå¯ä»¥å®‰å…¨åœ°åœ¨å¤šä¸ªgoroutineå…±äº«</span></span><br><span class="line"><span class="comment">// å®ç° io.Closeræ¥å£</span></span><br><span class="line"><span class="keyword">type</span> Pool <span class="keyword">struct</span> &#123;</span><br><span class="line">  m        sync.Mutex</span><br><span class="line">  resource <span class="keyword">chan</span> io.Closer</span><br><span class="line">  factory  <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(io.Closer, error)</span></span></span><br><span class="line">  closed   <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ErrPoolClosed èµ„æºæ± å·²å…³é—­çš„é”™è¯¯æ ‡ç¤º</span></span><br><span class="line"><span class="keyword">var</span> ErrPoolClosed = errors.New(<span class="string">&quot;Pool has been closed&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// New åˆ›å»ºPoolçš„å·¥å‚å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(fn <span class="keyword">func</span>()</span> <span class="params">(io.Closer, error)</span>, <span class="title">size</span> <span class="title">uint</span>) <span class="params">(*Pool, error)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> size &lt;= <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;size value too small&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &amp;Pool&#123;</span><br><span class="line">    factory:  fn,</span><br><span class="line">    resource: <span class="built_in">make</span>(<span class="keyword">chan</span> io.Closer, size),</span><br><span class="line">  &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Acquire ä»èµ„æºæ± ä¸­è·å–ä¸€ä¸ªèµ„æº</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Acquire</span><span class="params">()</span> <span class="params">(io.Closer, error)</span></span> &#123;</span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> r, ok := &lt;-p.resource:</span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰ç©ºé—²èµ„æº</span></span><br><span class="line">    log.Println(<span class="string">&quot;Acquire:&quot;</span>, <span class="string">&quot;Shared Resource&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, ErrPoolClosed</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r, <span class="literal">nil</span></span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰å¯ç”¨èµ„æºï¼Œå°±åˆ›å»ºä¸€ä¸ª</span></span><br><span class="line">    log.Println(<span class="string">&quot;Acquire:&quot;</span>, <span class="string">&quot;New Resource&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> p.factory()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Release é‡Šæ”¾ä¸€ä¸ªèµ„æºï¼Œå°†å…¶æ”¾å›èµ„æºæ± </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Release</span><span class="params">(r io.Closer)</span></span> &#123;</span><br><span class="line">  p.m.Lock()</span><br><span class="line">  <span class="keyword">defer</span> p.m.Unlock()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœè¯¥èµ„æºå·²ç»è¢«å…³é—­ï¼Œé”€æ¯è¿™ä¸ªèµ„æº</span></span><br><span class="line">  <span class="keyword">if</span> p.closed &#123;</span><br><span class="line">    r.Close()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> p.resource &lt;- r:</span><br><span class="line">    <span class="comment">// è¯•å›¾å°†è¯¥èµ„æºåŠ å…¥é˜Ÿåˆ—</span></span><br><span class="line">    log.Println(<span class="string">&quot;Release:&quot;</span>, <span class="string">&quot;In Queue&quot;</span>)</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="comment">// å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œå…³é—­è¿™ä¸ªèµ„æº</span></span><br><span class="line">    log.Println(<span class="string">&quot;Release:&quot;</span>, <span class="string">&quot;Closing&quot;</span>)</span><br><span class="line">    r.Close()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Close å…³é—­èµ„æºæ± ä¸­çš„æ‰€æœ‰èµ„æºï¼Œå¹¶åœæ­¢å·¥ä½œ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Close</span><span class="params">()</span></span> &#123;</span><br><span class="line">  p.m.Lock()</span><br><span class="line">  <span class="keyword">defer</span> p.m.Unlock()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> p.closed &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  p.closed = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">close</span>(p.resource)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å…³é—­æ‰€æœ‰èµ„æº</span></span><br><span class="line">  <span class="keyword">for</span> r := <span class="keyword">range</span> p.resource &#123;</span><br><span class="line">    r.Close()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>poolèµ„æºæ± å®ç°çš„æ ¸å¿ƒæ€æƒ³æ˜¯<strong>æœ‰ç¼“å†²é€šé“è¯»å†™æ—¶ä¸ä¼šå¼•èµ·é˜»å¡ï¼Œselectè¯­å¥åœ¨é€šé“å†…æ²¡æœ‰æ•°æ®çš„æƒ…å†µä¸‹ä¼šè‡ªåŠ¨æ‰§è¡Œdefaulté€‰é¡¹</strong>ã€‚</p>
<h2 id="work"><a href="#work" class="headerlink" title="work"></a>work</h2><p>workæ¨¡å¼å°±æ˜¯åˆ›å»ºä¸€ä¸ªgoroutineæ± ï¼Œç®¡ç†æ± ä¸­æ‰€æœ‰çš„goroutineç»Ÿä¸€æ‰§è¡Œã€‚ä½†å®ƒæœ‰åˆ«äºrunneræ¨¡å¼ï¼Œrunnerå…¶å®æ˜¯è´Ÿè´£ç›‘æ§æ± ä¸­çš„æ¯ä¸ªå¹¶å‘ä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸçš„ï¼Œè€Œworkåˆ™æ˜¯è´Ÿè´£æ± ä¸­çš„æ¯ä¸ªå¹¶å‘ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºï¼Œå³ä»»åŠ¡é˜Ÿåˆ—ã€‚</p>
<p>è¿™ä¸ªæ¨¡å¼çš„å¥½å¤„åœ¨äºï¼Œå¯ä»¥å¾ˆå¥½åœ°æ§åˆ¶ç¨‹åºè¿è¡Œçš„è´Ÿè½½ï¼Œæ¯”å¦‚çªå‘æƒ…å†µä¸‹ï¼ŒæŸå°æœåŠ¡å™¨çš„httpè¯·æ±‚ä¸€ç¬é—´åˆ°è¾¾100ä¸‡ï¼Œå¦‚æœä¸ºäº†å“åº”æ‰€æœ‰è¯·æ±‚ä¹Ÿåœ¨ä¸€ç¬èµ·å¯åŠ¨100ä¸‡ä¸ªå“åº”ä»»åŠ¡ï¼Œé‚£ä¼°è®¡æœåŠ¡å™¨å°±å†’çƒŸäº†ã€‚æ‰€ä»¥æœ€å¥½çš„æ–¹å¼å°±æ˜¯é™åˆ¶å¹¶å‘ä»»åŠ¡æ•°é‡ï¼Œæ¯”å¦‚æ¯æ¬¡æœ€å¤šå¯åŠ¨1ä¸‡ä¸ªå“åº”ï¼Œå‰©ä¸‹çš„æ’é˜Ÿæ…¢æ…¢æ¥ã€‚</p>
<p>å› æ­¤ï¼Œworkå°±æ˜¯ä¸€ä¸ªå¹¶å‘ä»»åŠ¡çš„é˜Ÿåˆ—æ± ï¼Œè¿˜æ˜¯å…ˆçœ‹çœ‹å¦‚ä½•è¿ç”¨çš„ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> names = []<span class="keyword">string</span>&#123;</span><br><span class="line">  <span class="string">&quot;steve&quot;</span>,</span><br><span class="line">  <span class="string">&quot;bob&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mary&quot;</span>,</span><br><span class="line">  <span class="string">&quot;therese&quot;</span>,</span><br><span class="line">  <span class="string">&quot;jason&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> namePrinter <span class="keyword">struct</span> &#123;</span><br><span class="line">  name <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Task å®ç°Workeræ¥å£</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *namePrinter)</span> <span class="title">Task</span><span class="params">()</span></span> &#123;</span><br><span class="line">  log.Println(m.name)</span><br><span class="line">  time.Sleep(time.Second)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">testWork</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// è®¾ç½®å·¥ä½œæ± çš„â€œå·¥ä½â€ä¸º2ï¼Œå³æ¯æ¬¡åªèƒ½æœ‰ä¸¤ä¸ªäººå·¥ä½œ</span></span><br><span class="line">  p := work.New(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">  wg.Add(<span class="number">100</span> * <span class="built_in">len</span>(names)) <span class="comment">// æ¯äººè‚©è´Ÿ100é¡¹ä»»åŠ¡ï¼Œå…±5äºº</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸€æ¬¡æ€§æŠŠ5 * 100ä¸ªä»»åŠ¡å…¨éƒ¨ä¸¢åˆ°å·¥ä½œæ± ä¸­</span></span><br><span class="line">  <span class="comment">// ç›¸å½“äºåˆ›å»ºäº†500ä¸ªgoroutine</span></span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ &#123;</span><br><span class="line">    <span class="keyword">for</span> _, name := <span class="keyword">range</span> names &#123;</span><br><span class="line">      np := namePrinter&#123;name: name&#125;</span><br><span class="line">      <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        p.Run(&amp;np) <span class="comment">// å°†å¯¹è±¡çš„ä»»åŠ¡ä¸¢åˆ°å·¥ä½œæ± ä¸­ç»Ÿä¸€ç®¡ç†æ‰§è¡Œ</span></span><br><span class="line">        wg.Done()</span><br><span class="line">      &#125;()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡åœ¨å·¥ä½œæ± ä¸­è¢«å®Œæˆ</span></span><br><span class="line">  wg.Wait()</span><br><span class="line">  p.Shutdown()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚ä¸Šä»£ç ï¼ŒnamePrinterå®ç°äº†workåŒ…å†…è§„å®šçš„<code>Task</code>æ¥å£ä¹‹åï¼Œworkçš„å·¥ä½œæ± å°±èƒ½å¤Ÿç»Ÿä¸€ç®¡ç†namePrinterå¯¹è±¡äº†ã€‚è¿™ä¸ªnamePrinterå¯ä»¥ç†è§£ä¸ºæŸä¸ªä¸šåŠ¡çš„æ¨¡æ‹Ÿï¼Œæ¯”å¦‚ä¸Šé¢è¯´çš„httpå“åº”ä»»åŠ¡(è¿™é‡Œä»…æ˜¯ç®€å•åœ°åšä¸ªæ‰“å°)ã€‚</p>
<p>è€Œåï¼Œä¸è®ºåˆ›å»ºå¤šå°‘ä¸ªnamePrinterç›¸å…³çš„goroutine(å¹¶å‘)ï¼Œéƒ½åªéœ€ç®€å•åœ°å°†å…¶ä¸¢åˆ°å·¥ä½œæ± ä¸­Run(p.Runå¹¶æ²¡æœ‰ç«‹åˆ»å¯åŠ¨ä»»åŠ¡ï¼Œå·¥ä½œæ± ä¼šæ ¹æ®æƒ…å†µè‡ªè¡Œå®‰æ’)ã€‚</p>
<p>æœ€ååœ¨çœ‹çœ‹workåŒ…çš„å®ç°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Worker å¿…é¡»æ»¡è¶³æ¥å£ï¼Œæ‰èƒ½ä½¿ç”¨å·¥ä½œæ± </span></span><br><span class="line"><span class="keyword">type</span> Worker <span class="keyword">interface</span> &#123;</span><br><span class="line">  Task()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pool å·¥ä½œæ± ï¼Œç›¸å½“äºgoroutinesæ± ç®¡ç†</span></span><br><span class="line"><span class="keyword">type</span> Pool <span class="keyword">struct</span> &#123;</span><br><span class="line">  work <span class="keyword">chan</span> Worker</span><br><span class="line">  wg   sync.WaitGroup</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// New åˆ›å»ºå·¥ä½œæ± çš„å·¥å‚å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(maxGoroutines <span class="keyword">int</span>)</span> *<span class="title">Pool</span></span> &#123;</span><br><span class="line">  p := Pool&#123;</span><br><span class="line">    work: <span class="built_in">make</span>(<span class="keyword">chan</span> Worker),</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  p.wg.Add(maxGoroutines)</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; maxGoroutines; i++ &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="comment">// p.workæ˜¯é€šé“ï¼Œæ‰€æœ‰åˆ›å»ºgoroutineä¹‹å</span></span><br><span class="line">      <span class="comment">// forå¾ªç¯ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°p.workè¢«å…³é—­ä¸ºæ­¢</span></span><br><span class="line">      <span class="keyword">for</span> w := <span class="keyword">range</span> p.work &#123;</span><br><span class="line">        w.Task()</span><br><span class="line">      &#125;</span><br><span class="line">      p.wg.Done()</span><br><span class="line">    &#125;()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &amp;p</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Run æäº¤å·¥ä½œåˆ°å·¥ä½œæ± </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Run</span><span class="params">(w Worker)</span></span> &#123;</span><br><span class="line">  p.work &lt;- w</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Shutdown ç­‰å¾…æ‰€æœ‰goroutinesç»“æŸ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Shutdown</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="built_in">close</span>(p.work)</span><br><span class="line">  p.wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>workçš„å®ç°å…¶å®æ˜¯éå¸¸ç®€å•çš„ï¼Œ<strong>æ ¸å¿ƒæ€æƒ³æ˜¯for-rangeå¾ªç¯æ—¶ï¼Œæ— ç¼“å†²é€šé“ä¼šé˜»å¡</strong>ï¼Œå·¥ä½œæ± æ˜¯ä¸€ä¸ªæ— ç¼“å†²é€šé“ï¼Œè€Œæ¯ä¸ªfor-rangeéƒ½ç›¸å½“äºä¸€ä¸ªé˜Ÿåˆ—ï¼Œå½“æ± ä¸­æœ‰æ•°æ®æ˜¯ï¼Œæ‰€æœ‰çš„for-rangeéƒ½ä¼šäº‰å¤ºè¿™ä¸ªè¾“å…¥æ•°æ®æ¥å¤„ç†ï¼Œä½†å¦‚æœæŸä¸ªé˜Ÿåˆ—æœ¬èº«å·²ç»åœ¨å·¥ä½œæ—¶ï¼Œå°±æ²¡ç©ºå†äº‰å¤ºé€šé“å†…çš„æ•°æ®ã€‚å¯ä»¥è¯´æ˜¯æœ€ç®€å•æœ‰æ•ˆçš„è´Ÿè½½å‡è¡¡ã€‚</p>
<h2 id="å°ç»“ä¸€ä¸‹"><a href="#å°ç»“ä¸€ä¸‹" class="headerlink" title="å°ç»“ä¸€ä¸‹"></a>å°ç»“ä¸€ä¸‹</h2><ul>
<li>æ— ç¼“å†²é€šé“åœ¨è¯»å†™æ—¶ä¼šå¼•èµ·é˜»å¡ï¼Œå¯ä»¥ç”¨æ¥æ§åˆ¶ç¨‹åºç”Ÿå‘½å‘¨æœŸ</li>
<li>å¸¦defaultåˆ†æ”¯çš„selectè¯­å¥ä¼šå°è¯•è¯»å†™é€šé“ï¼Œè€Œä¸ä¼šé˜»å¡</li>
<li>å¯ä»¥åˆ©ç”¨æ— ç¼“å†²é€šé“åˆ›å»ºä¸€ä¸ªå·¥ä½œæ± ï¼Œç»Ÿä¸€ç®¡ç†goroutineå¹¶å‘ä»»åŠ¡</li>
<li>å¯ä»¥åˆ©ç”¨æœ‰ç¼“å†²é€šé“åˆ›å»ºä¸€ä¸ªèµ„æºæ± ï¼Œç»Ÿä¸€ç®¡ç†å¹¶å‘æ—¶çš„èµ„æºè®¿é—®</li>
</ul>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>æœ¬æ–‡ä½œè€…ï¼š </strong>Philon
  </li>
  <li class="post-copyright-link">
    <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
    <a href="https://ixx.life/GoInAction/chapter7/" title="ä¸ƒï¼šå¹¶å‘æ¨¡å¼">https://ixx.life/GoInAction/chapter7/</a>
  </li>
  <li class="post-copyright-license">
    <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/GO%E8%AF%AD%E8%A8%80/" rel="tag"># GOè¯­è¨€</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/97ThingsEveryProgrammerShouldKnow/30/" rel="prev" title="ä¸è¦é‡å¤è‡ªæˆ‘">
      <i class="fa fa-chevron-left"></i> ä¸è¦é‡å¤è‡ªæˆ‘
    </a></div>
      <div class="post-nav-item">
    <a href="/books/%E4%B9%8C%E5%90%88%E4%B9%8B%E4%BC%97/" rel="next" title="ä¸‰äººä¸ºè™-ã€Šä¹Œåˆä¹‹ä¼—ã€‹è¯»ä¹¦æ„Ÿæ‚Ÿ">
      ä¸‰äººä¸ºè™-ã€Šä¹Œåˆä¹‹ä¼—ã€‹è¯»ä¹¦æ„Ÿæ‚Ÿ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Philon"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Philon</p>
  <div class="site-description" itemprop="description">ä¸€ä¸ªç¨‹åºå‘˜çš„æˆé•¿è¶³è¿¹</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">177</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">77</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/philon" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;philon" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ixx.life</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'Y5scg9Ix4iae04UOae0uJSJA-gzGzoHsz',
      appKey     : 'U9hHApgNVDExYRJqXvUs5ykr',
      placeholder: "è¯´ç‚¹ä»€ä¹ˆå§...",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
